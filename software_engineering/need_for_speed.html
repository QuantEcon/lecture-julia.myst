
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>13. The Need for Speed &#8212; Quantitative Economics with Julia</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol']},
            tex: {
                packages: {'[+]': ['boldsymbol']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/quantecon-book-theme.857ff391aaabaeb8c161d2309c375fe6.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">


    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="../_static/quantecon-book-theme.76bf49d7bbc59738cdb03766fad654af.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"Macros": {"argmax": "arg\\,max", "argmin": "arg\\,min"}}, "tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://julia.quantecon.org/software_engineering/need_for_speed.html" />
    <link rel="shortcut icon" href="../_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="14. Geometric Series for Elementary Economics" href="../tools_and_techniques/geom_series.html" />
    <link rel="prev" title="12. Packages, Testing, and Continuous Integration" href="testing.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Jesse Perla &amp; Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Julia, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="The Need for Speed"/>
<meta name="twitter:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="The Need for Speed" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://julia.quantecon.org/software_engineering/need_for_speed.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia." />
<meta property="og:site_name" content="Quantitative Economics with Julia" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="wrapper">

        <div class="main">

            <div class="page" id=software_engineering/need_for_speed>

                <div class="page__toc">

                    <div class="inner">

                        
                        <div class="page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   13.1. Overview
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#requirements">
     13.1.1. Requirements
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#understanding-multiple-dispatch-in-julia">
   13.2. Understanding Multiple Dispatch in Julia
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#methods-and-functions">
     13.2.1. Methods and Functions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#adding-methods">
       13.2.1.1. Adding Methods
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#understanding-the-compilation-process">
     13.2.2. Understanding the Compilation Process
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#analyzing-function-return-types">
     13.2.3. Analyzing Function Return Types
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#foundations">
   13.3. Foundations
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#machine-code">
     13.3.1. Machine Code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-machine-code">
     13.3.2. Generating Machine Code
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#aot-compiled-languages">
       13.3.2.1. AOT Compiled Languages
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#interpreted-languages">
       13.3.2.2. Interpreted Languages
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#just-in-time-compilation">
       13.3.2.3. Just-in-time compilation
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#jit-compilation-in-julia">
   13.4. JIT Compilation in Julia
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#an-example">
     13.4.1. An Example
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#potential-problems">
     13.4.2. Potential Problems
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fast-and-slow-julia-code">
   13.5. Fast and Slow Julia Code
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#benchmarktools">
     13.5.1. BenchmarkTools
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#global-variables">
     13.5.2. Global Variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#composite-types-with-abstract-field-types">
     13.5.3. Composite Types with Abstract Field Types
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#timing">
       13.5.3.1. Timing
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#type-inference">
     13.5.4. Type Inference
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#type-inferences">
       13.5.4.1. Type Inferences
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#an-abstract-container">
       13.5.4.2. An Abstract Container
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#further-comments">
   13.6. Further Comments
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#summary-and-tips">
     13.6.1. Summary and Tips
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#further-reading">
     13.6.2. Further Reading
    </a>
   </li>
  </ul>
 </li>
</ul>

                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="../_static/qe-logo-large.png" class="logo" alt="logo"></a>
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="page__header">

                    <div class="page__header-copy">

                        <p class="page__header-heading"><a href="../intro.html">Quantitative Economics with Julia</a></p>

                        <p class="page__header-subheading">The Need for Speed</p>

                    </div>

                    <p class="page__header-authors">Jesse Perla & Thomas J. Sargent & John Stachurski</p>

                </div> <!-- .page__header -->



                
                <main class="page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><div class="section" id="the-need-for-speed">
<h1><a class="toc-backref" href="#id1"><span class="section-number">13. </span>The Need for Speed</a><a class="headerlink" href="#the-need-for-speed" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#the-need-for-speed" id="id1">The Need for Speed</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id2">Overview</a></p></li>
<li><p><a class="reference internal" href="#understanding-multiple-dispatch-in-julia" id="id3">Understanding Multiple Dispatch in Julia</a></p></li>
<li><p><a class="reference internal" href="#foundations" id="id4">Foundations</a></p></li>
<li><p><a class="reference internal" href="#jit-compilation-in-julia" id="id5">JIT Compilation in Julia</a></p></li>
<li><p><a class="reference internal" href="#fast-and-slow-julia-code" id="id6">Fast and Slow Julia Code</a></p></li>
<li><p><a class="reference internal" href="#further-comments" id="id7">Further Comments</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id2"><span class="section-number">13.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Computer scientists often classify programming languages according to the following two categories.</p>
<p><em>High level languages</em> aim to maximize productivity by</p>
<ul class="simple">
<li><p>being easy to read, write and debug</p></li>
<li><p>automating standard tasks (e.g., memory management)</p></li>
<li><p>being interactive, etc.</p></li>
</ul>
<p><em>Low level languages</em> aim for speed and control, which they achieve by</p>
<ul class="simple">
<li><p>being closer to the metal (direct access to CPU, memory, etc.)</p></li>
<li><p>requiring a relatively large amount of information from the user (e.g., all data types must be specified)</p></li>
</ul>
<p>Traditionally we understand this as a trade off</p>
<ul class="simple">
<li><p>high productivity or high performance</p></li>
<li><p>optimized for humans or optimized for machines</p></li>
</ul>
<p>One of the great strengths of Julia is that it pushes out the curve, achieving
both high productivity and high performance with relatively little fuss.</p>
<p>The word “relatively” is important here, however…</p>
<p>In simple programs, excellent performance is often trivial to achieve.</p>
<p>For longer, more sophisticated programs, you need to be aware of potential stumbling blocks.</p>
<p>This lecture covers the key points.</p>
<div class="section" id="requirements">
<h3><span class="section-number">13.1.1. </span>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<p>You should read our <a class="reference internal" href="../more_julia/generic_programming.html"><span class="doc">earlier lecture</span></a> on types, methods and multiple dispatch before this one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">LinearAlgebra</span><span class="p">,</span> <span class="n">Statistics</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="understanding-multiple-dispatch-in-julia">
<h2><a class="toc-backref" href="#id3"><span class="section-number">13.2. </span>Understanding Multiple Dispatch in Julia</a><a class="headerlink" href="#understanding-multiple-dispatch-in-julia" title="Permalink to this headline">¶</a></h2>
<p>This section provides more background on how methods, functions, and types are connected.</p>
<div class="section" id="methods-and-functions">
<h3><span class="section-number">13.2.1. </span>Methods and Functions<a class="headerlink" href="#methods-and-functions" title="Permalink to this headline">¶</a></h3>
<p>The precise data type is important, for reasons of both efficiency and mathematical correctness.</p>
<p>For example consider 1 + 1 vs. 1.0 + 1.0 or [1 0] + [0 1].</p>
<p>On a CPU, integer and floating point addition are different things, using a different set of instructions.</p>
<p>Julia handles this problem by storing multiple, specialized versions of functions like addition, one for each data type or set of data types.</p>
<p>These individual specialized versions are called <strong>methods</strong>.</p>
<p>When an operation like addition is requested, the Julia compiler inspects the type of data to be acted on and hands it out to the appropriate method.</p>
<p>This process is called <strong>multiple dispatch</strong>.</p>
<p>Like all “infix” operators, 1 + 1 has the alternative syntax +(1, 1)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<p>This operator + is itself a function with multiple methods.</p>
<p>We can investigate them using the &#64;which macro, which shows the method to which a given call is dispatched</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
<span class="nd">@which</span> <span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">+(x::<b>Float64</b>, y::<b>Float64</b>) in Base at <a href="https://github.com/JuliaLang/julia/tree/ac5cc99908d463582e66db3368b9b48fae1e2525/base/float.jl#L399" target="_blank">float.jl:399</a></div></div>
</div>
<p>We see that the operation is sent to the <code class="docutils literal notranslate"><span class="pre">+</span></code> method that specializes in adding
floating point numbers.</p>
<p>Here’s the integer case</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<span class="nd">@which</span> <span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">+(x::<b>T</b>, y::<b>T</b>)<i> where T<:Union{Int128, Int16, Int32, Int64, Int8, UInt128, UInt16, UInt32, UInt64, UInt8}</i> in Base at <a href="https://github.com/JuliaLang/julia/tree/ac5cc99908d463582e66db3368b9b48fae1e2525/base/int.jl#L87" target="_blank">int.jl:87</a></div></div>
</div>
<p>This output says that the call has been dispatched to the + method
responsible for handling integer values.</p>
<p>(We’ll learn more about the details of this syntax below)</p>
<p>Here’s another example, with complex numbers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="nb">im</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="nb">im</span>
<span class="nd">@which</span> <span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">+(z::<b>Complex</b>, w::<b>Complex</b>) in Base at <a href="https://github.com/JuliaLang/julia/tree/ac5cc99908d463582e66db3368b9b48fae1e2525/base/complex.jl#L288" target="_blank">complex.jl:288</a></div></div>
</div>
<p>Again, the call has been dispatched to a + method specifically designed for handling the given data type.</p>
<div class="section" id="adding-methods">
<h4><span class="section-number">13.2.1.1. </span>Adding Methods<a class="headerlink" href="#adding-methods" title="Permalink to this headline">¶</a></h4>
<p>It’s straightforward to add methods to existing functions.</p>
<p>For example, we can’t at present add an integer and a string in Julia (i.e. <code class="docutils literal notranslate"><span class="pre">100</span> <span class="pre">+</span> <span class="pre">&quot;100&quot;</span></code> is not valid syntax).</p>
<p>This is sensible behavior, but if you want to change it there’s nothing to stop you.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">import</span> <span class="n">Base</span><span class="o">:</span> <span class="o">+</span>  <span class="c"># enables adding methods to the + function</span>
<span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span> <span class="n">y</span><span class="o">::</span><span class="kt">String</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">parse</span><span class="p">(</span><span class="kt">Int</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nd">@show</span> <span class="o">+</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="s">&quot;100&quot;</span><span class="p">)</span>
<span class="nd">@show</span> <span class="mi">100</span> <span class="o">+</span> <span class="s">&quot;100&quot;</span><span class="p">;</span>  <span class="c"># equivalent</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100 + &quot;100&quot; = 200
100 + &quot;100&quot; = 200
</pre></div>
</div>
</div>
</div>
<p>The above code is not executed to avoid any chance of a <a class="reference external" href="https://julialang.org/blog/2020/08/invalidations/">method invalidation</a>, where are a source of compile-time latency.</p>
</div>
</div>
<div class="section" id="understanding-the-compilation-process">
<h3><span class="section-number">13.2.2. </span>Understanding the Compilation Process<a class="headerlink" href="#understanding-the-compilation-process" title="Permalink to this headline">¶</a></h3>
<p>We can now be a little bit clearer about what happens when you call a function on given types.</p>
<p>Suppose we execute the function call <code class="docutils literal notranslate"><span class="pre">f(a,</span> <span class="pre">b)</span></code> where <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>
are of concrete types <code class="docutils literal notranslate"><span class="pre">S</span></code> and <code class="docutils literal notranslate"><span class="pre">T</span></code> respectively.</p>
<p>The Julia interpreter first queries the types of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> to obtain the tuple <code class="docutils literal notranslate"><span class="pre">(S,</span> <span class="pre">T)</span></code>.</p>
<p>It then parses the list of methods belonging to <code class="docutils literal notranslate"><span class="pre">f</span></code>, searching for a match.</p>
<p>If it finds a method matching <code class="docutils literal notranslate"><span class="pre">(S,</span> <span class="pre">T)</span></code> it calls that method.</p>
<p>If not, it looks to see whether the pair <code class="docutils literal notranslate"><span class="pre">(S,</span> <span class="pre">T)</span></code> matches any method defined for <em>immediate parent types</em>.</p>
<p>For example, if <code class="docutils literal notranslate"><span class="pre">S</span></code> is <code class="docutils literal notranslate"><span class="pre">Float64</span></code> and <code class="docutils literal notranslate"><span class="pre">T</span></code> is <code class="docutils literal notranslate"><span class="pre">ComplexF32</span></code> then the
immediate parents are <code class="docutils literal notranslate"><span class="pre">AbstractFloat</span></code> and <code class="docutils literal notranslate"><span class="pre">Number</span></code> respectively</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">supertype</span><span class="p">(</span><span class="kt">Float64</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AbstractFloat
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">supertype</span><span class="p">(</span><span class="kt">ComplexF32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number
</pre></div>
</div>
</div>
</div>
<p>Hence the interpreter looks next for a method of the form <code class="docutils literal notranslate"><span class="pre">f(x::AbstractFloat,</span> <span class="pre">y::Number)</span></code>.</p>
<p>If the interpreter can’t find a match in immediate parents (supertypes) it proceeds up the tree, looking at the parents of the last type it checked at each iteration.</p>
<ul class="simple">
<li><p>If it eventually finds a matching method, it invokes that method.</p></li>
<li><p>If not, we get an error.</p></li>
</ul>
<p>This is the process that leads to the following error (since we only added the <code class="docutils literal notranslate"><span class="pre">+</span></code> for adding <code class="docutils literal notranslate"><span class="pre">Integer</span></code> and <code class="docutils literal notranslate"><span class="pre">String</span></code> above)</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@show</span> <span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="mf">100.0</span><span class="p">)</span> <span class="o">&lt;:</span> <span class="kt">Integer</span><span class="p">)</span> <span class="o">==</span> <span class="nb">false</span>
<span class="mf">100.0</span> <span class="o">+</span> <span class="s">&quot;100&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(typeof(100.0) &lt;: Integer) == false = true
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="ne">MethodError</span>: no method matching +(::Float64, ::String)
<span class="n">Closest</span> <span class="n">candidates</span> <span class="n">are</span><span class="p">:</span>
  <span class="o">+</span><span class="p">(::</span><span class="n">Any</span><span class="p">,</span> <span class="p">::</span><span class="n">Any</span><span class="p">,</span> <span class="p">::</span><span class="n">Any</span><span class="p">,</span> <span class="p">::</span><span class="n">Any</span><span class="o">...</span><span class="p">)</span> <span class="n">at</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="mf">1.7.1</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">operators</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">655</span>
  <span class="o">+</span><span class="p">(::</span><span class="n">Union</span><span class="p">{</span><span class="n">Float16</span><span class="p">,</span> <span class="n">Float32</span><span class="p">,</span> <span class="n">Float64</span><span class="p">},</span> <span class="p">::</span><span class="n">BigFloat</span><span class="p">)</span> <span class="n">at</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="mf">1.7.1</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="n">mpfr</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">406</span>
  <span class="o">+</span><span class="p">(::</span><span class="n">AbstractFloat</span><span class="p">,</span> <span class="p">::</span><span class="n">Bool</span><span class="p">)</span> <span class="n">at</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">hostedtoolcache</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="mf">1.7.1</span><span class="o">/</span><span class="n">x64</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">julia</span><span class="o">/</span><span class="n">base</span><span class="o">/</span><span class="nb">bool</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">172</span>
  <span class="o">...</span>

<span class="ne">Stacktrace</span>:
 <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">top</span><span class="o">-</span><span class="n">level</span> <span class="n">scope</span>
   <span class="o">@</span> <span class="n">In</span><span class="p">[</span><span class="mi">9</span><span class="p">]:</span><span class="mi">2</span>
 <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="nb">eval</span>
   <span class="o">@</span> <span class="o">./</span><span class="n">boot</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">373</span> <span class="p">[</span><span class="n">inlined</span><span class="p">]</span>
 <span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="n">include_string</span><span class="p">(</span><span class="n">mapexpr</span><span class="p">::</span><span class="n">typeof</span><span class="p">(</span><span class="n">REPL</span><span class="o">.</span><span class="n">softscope</span><span class="p">),</span> <span class="n">mod</span><span class="p">::</span><span class="n">Module</span><span class="p">,</span> <span class="n">code</span><span class="p">::</span><span class="n">String</span><span class="p">,</span> <span class="n">filename</span><span class="p">::</span><span class="n">String</span><span class="p">)</span>
   <span class="o">@</span> <span class="n">Base</span> <span class="o">./</span><span class="n">loading</span><span class="o">.</span><span class="n">jl</span><span class="p">:</span><span class="mi">1196</span>
</pre></div>
</div>
</div>
</div>
<p>Because the dispatch procedure starts from concrete types and works upwards, dispatch always invokes the <em>most specific method</em> available.</p>
<p>For example, if you have methods for function <code class="docutils literal notranslate"><span class="pre">f</span></code> that handle</p>
<ol class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(Float64,</span> <span class="pre">Int64)</span></code> pairs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(Number,</span> <span class="pre">Number)</span></code> pairs</p></li>
</ol>
<p>and you call <code class="docutils literal notranslate"><span class="pre">f</span></code> with <code class="docutils literal notranslate"><span class="pre">f(0.5,</span> <span class="pre">1)</span></code> then the first method will be invoked.</p>
<p>This makes sense because (hopefully) the first method is optimized for
exactly this kind of data.</p>
<p>The second method is probably more of a “catch all” method that handles other
data in a less optimal way.</p>
<p>Here’s another simple example, involving a user-defined function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">q</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c"># or q(x::Any)</span>
    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Default (Any) method invoked&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">q</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">Number</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Number method invoked&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">q</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Integer method invoked&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>q (generic function with 3 methods)
</pre></div>
</div>
</div>
</div>
<p>Let’s now run this and see how it relates to our discussion of method dispatch
above</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Integer method invoked
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">(</span><span class="mf">3.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number method invoked
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">q</span><span class="p">(</span><span class="s">&quot;foo&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Default (Any) method invoked
</pre></div>
</div>
</div>
</div>
<p>Since <code class="docutils literal notranslate"><span class="pre">typeof(3)</span> <span class="pre">&lt;:</span> <span class="pre">Int64</span> <span class="pre">&lt;:</span> <span class="pre">Integer</span> <span class="pre">&lt;:</span> <span class="pre">Number</span></code>, the call <code class="docutils literal notranslate"><span class="pre">q(3)</span></code> proceeds up the tree to <code class="docutils literal notranslate"><span class="pre">Integer</span></code> and invokes <code class="docutils literal notranslate"><span class="pre">q(x::Integer)</span></code>.</p>
<p>On the other hand, <code class="docutils literal notranslate"><span class="pre">3.0</span></code> is a <code class="docutils literal notranslate"><span class="pre">Float64</span></code>, which is not a subtype of  <code class="docutils literal notranslate"><span class="pre">Integer</span></code>.</p>
<p>Hence the call <code class="docutils literal notranslate"><span class="pre">q(3.0)</span></code> continues up to <code class="docutils literal notranslate"><span class="pre">q(x::Number)</span></code>.</p>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">q(&quot;foo&quot;)</span></code> is handled by the function operating on <code class="docutils literal notranslate"><span class="pre">Any</span></code>, since <code class="docutils literal notranslate"><span class="pre">String</span></code> is not a subtype of <code class="docutils literal notranslate"><span class="pre">Number</span></code> or <code class="docutils literal notranslate"><span class="pre">Integer</span></code>.</p>
</div>
<div class="section" id="analyzing-function-return-types">
<h3><span class="section-number">13.2.3. </span>Analyzing Function Return Types<a class="headerlink" href="#analyzing-function-return-types" title="Permalink to this headline">¶</a></h3>
<p>For the most part, time spent “optimizing” Julia code to run faster is about ensuring the compiler can correctly deduce types for all functions.</p>
<p>The macro <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> gives us a hint</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="n">x</span>
<span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Vector{Int64})
  from f(x) in Main at In[14]:2
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
Body<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
1 ─ %1 = (2 * x)<span class=" -Color -Color-Cyan">::Vector{Int64}</span>
└──      return %1
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;code_warntype</span></code> macro compiles <code class="docutils literal notranslate"><span class="pre">f(x)</span></code> using the type of <code class="docutils literal notranslate"><span class="pre">x</span></code> as an example – i.e., the <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code> is used as a prototype for analyzing the compilation, rather than simply calculating the value.</p>
<p>Here, the <code class="docutils literal notranslate"><span class="pre">Body::Array{Int64,1}</span></code> tells us the type of the return value of the
function, when called with types like <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">3]</span></code>, is always a vector of integers.</p>
<p>In contrast, consider a function potentially returning <code class="docutils literal notranslate"><span class="pre">nothing</span></code>, as in <a class="reference internal" href="../getting_started_julia/fundamental_types.html"><span class="doc">this lecture</span></a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="nb">nothing</span>
<span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Int64)
  from f(x) in Main at In[15]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Bold -Color-Bold-Yellow">::Union{Nothing, Int64}</span>
1 ─ %1 = (x &gt; 0.0)<span class=" -Color -Color-Cyan">::Bool</span>
└──      goto #3 if not %1
2 ─      return x
3 ─      return Main.nothing
</pre></div>
</div>
</div>
</div>
<p>This states that the compiler determines the return type when called with an integer (like <code class="docutils literal notranslate"><span class="pre">1</span></code>) could be one of two different types, <code class="docutils literal notranslate"><span class="pre">Body::Union{Nothing,</span> <span class="pre">Int64}</span></code>.</p>
<p>A final example is a variation on the above, which returns the maximum of <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="mf">0.0</span>
<span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Int64)
  from f(x) in Main at In[16]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Int64</span>
Body<span class=" -Color -Color-Bold">::Union{Float64, Int64}</span>
1 ─ %1 = (x &gt; 0.0)<span class=" -Color -Color-Cyan">::Bool</span>
└──      goto #3 if not %1
2 ─      return x
3 ─      return 0.0
</pre></div>
</div>
</div>
</div>
<p>Which shows that, when called with an integer, the type could be that integer or the floating point <code class="docutils literal notranslate"><span class="pre">0.0</span></code>.</p>
<p>On the other hand, if we use change the function to return <code class="docutils literal notranslate"><span class="pre">0</span></code> if x &lt;= 0, it is type-unstable with  floating point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="mi">0</span>
<span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>MethodInstance for f(::Float64)
  from f(x) in Main at In[17]:1
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
Body<span class=" -Color -Color-Bold">::Union{Float64, Int64}</span>
1 ─ %1 = (x &gt; 0.0)<span class=" -Color -Color-Cyan">::Bool</span>
└──      goto #3 if not %1
2 ─      return x
3 ─      return 0
</pre></div>
</div>
</div>
</div>
<p>The solution is to use the <code class="docutils literal notranslate"><span class="pre">zero(x)</span></code> function which returns the additive identity element of type <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>On the other hand, if we change the function to return <code class="docutils literal notranslate"><span class="pre">0</span></code> if <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;=</span> <span class="pre">0</span></code>, it is type-unstable with  floating point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@show</span> <span class="n">zero</span><span class="p">(</span><span class="mf">2.3</span><span class="p">)</span>
<span class="nd">@show</span> <span class="n">zero</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nd">@show</span> <span class="n">zero</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">+</span> <span class="mi">3</span><span class="nb">im</span><span class="p">)</span>

<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="n">zero</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="nd">@code_warntype</span> <span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>zero(2.3) = 0.0
zero(4) = 0
zero(2.0 + 3im) = 0.0 + 0.0im
MethodInstance for f(::Float64)
  from f(x) in Main at In[18]:5
Arguments
  #self#<span class=" -Color -Color-Cyan">::Core.Const(f)</span>
  x<span class=" -Color -Color-Cyan">::Float64</span>
Body<span class=" -Color -Color-Cyan">::Float64</span>
1 ─ %1 = (x &gt; 0.0)<span class=" -Color -Color-Cyan">::Bool</span>
└──      goto #3 if not %1
2 ─      return x
3 ─ %4 = Main.zero(x)<span class=" -Color -Color-Cyan">::Core.Const(0.0)</span>
└──      return %4
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="foundations">
<h2><a class="toc-backref" href="#id4"><span class="section-number">13.3. </span>Foundations</a><a class="headerlink" href="#foundations" title="Permalink to this headline">¶</a></h2>
<p>Let’s think about how quickly code runs, taking as given</p>
<ul class="simple">
<li><p>hardware configuration</p></li>
<li><p>algorithm (i.e., set of instructions to be executed)</p></li>
</ul>
<p>We’ll start by discussing the kinds of instructions that machines understand.</p>
<div class="section" id="machine-code">
<h3><span class="section-number">13.3.1. </span>Machine Code<a class="headerlink" href="#machine-code" title="Permalink to this headline">¶</a></h3>
<p>All instructions for computers end up as <em>machine code</em>.</p>
<p>Writing fast code — expressing a given algorithm so that it runs quickly — boils down to producing efficient machine code.</p>
<p>You can do this yourself, by hand, if you want to.</p>
<p>Typically this is done by writing <a class="reference external" href="https://en.wikipedia.org/wiki/Assembly_language">assembly</a>, which is a symbolic representation of machine code.</p>
<p>Here’s some assembly code implementing a function that takes arguments <span class="math notranslate nohighlight">\(a, b\)</span> and returns <span class="math notranslate nohighlight">\(2a + 8b\)</span></p>
<div class="highlight-asm notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="nf">pushq</span><span class="w">   </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">movq</span><span class="w">    </span><span class="nv">%rsp</span><span class="p">,</span><span class="w"> </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">addq</span><span class="w">    </span><span class="nv">%rdi</span><span class="p">,</span><span class="w"> </span><span class="nv">%rdi</span><span class="w"></span>
<span class="w">    </span><span class="nf">leaq</span><span class="w">    </span><span class="p">(</span><span class="nv">%rdi</span><span class="p">,</span><span class="nv">%rsi</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span><span class="w"> </span><span class="nv">%rax</span><span class="w"></span>
<span class="w">    </span><span class="nf">popq</span><span class="w">    </span><span class="nv">%rbp</span><span class="w"></span>
<span class="w">    </span><span class="nf">retq</span><span class="w"></span>
<span class="w">    </span><span class="nf">nopl</span><span class="w">    </span><span class="p">(</span><span class="nv">%rax</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Note that this code is specific to one particular piece of hardware that we use — different machines require different machine code.</p>
<p>If you ever feel tempted to start rewriting your economic model in assembly, please restrain yourself.</p>
<p>It’s far more sensible to give these instructions in a language like Julia,
where they can be easily written and understood.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="n">a</span> <span class="o">+</span> <span class="mi">8</span><span class="n">b</span>
    <span class="k">return</span> <span class="n">y</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<p>or Python</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">b</span>
    <span class="k">return</span> <span class="n">y</span>
</pre></div>
</div>
<p>or even C</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>In any of these languages we end up with code that is much easier for humans to write, read, share and debug.</p>
<p>We leave it up to the machine itself to turn our code into machine code.</p>
<p>How exactly does this happen?</p>
</div>
<div class="section" id="generating-machine-code">
<h3><span class="section-number">13.3.2. </span>Generating Machine Code<a class="headerlink" href="#generating-machine-code" title="Permalink to this headline">¶</a></h3>
<p>The process for turning high level code into machine code differs across
languages.</p>
<p>Let’s look at some of the options and how they differ from one another.</p>
<div class="section" id="aot-compiled-languages">
<h4><span class="section-number">13.3.2.1. </span>AOT Compiled Languages<a class="headerlink" href="#aot-compiled-languages" title="Permalink to this headline">¶</a></h4>
<p>Traditional compiled languages like Fortran, C and C++ are a reasonable option for writing fast code.</p>
<p>Indeed, the standard benchmark for performance is still well-written C or Fortran.</p>
<p>These languages compile down to efficient machine code because users are forced to provide a lot of detail on data types and how the code will execute.</p>
<p>The compiler therefore has ample information for building the corresponding machine code ahead of time (AOT) in a way that</p>
<ul class="simple">
<li><p>organizes the data optimally in memory and</p></li>
<li><p>implements efficient operations as required for the task in hand</p></li>
</ul>
<p>At the same time, the syntax and semantics of C and Fortran are verbose and unwieldy when compared to something like Julia.</p>
<p>Moreover, these low level languages lack the interactivity that’s so crucial for scientific work.</p>
</div>
<div class="section" id="interpreted-languages">
<h4><span class="section-number">13.3.2.2. </span>Interpreted Languages<a class="headerlink" href="#interpreted-languages" title="Permalink to this headline">¶</a></h4>
<p>Interpreted languages like Python generate machine code “on the fly”, during program execution.</p>
<p>This allows them to be flexible and interactive.</p>
<p>Moreover, programmers can leave many tedious details to the runtime environment, such as</p>
<ul class="simple">
<li><p>specifying variable types</p></li>
<li><p>memory allocation/deallocation, etc.</p></li>
</ul>
<p>But all this convenience and flexibility comes at a cost: it’s hard to turn
instructions written in these languages into efficient machine code.</p>
<p>For example, consider what happens when Python adds a long list of numbers
together.</p>
<p>Typically the runtime environment has to check the type of these objects one by one before it figures out how to add them.</p>
<p>This involves substantial overheads.</p>
<p>There are also significant overheads associated with accessing the data values themselves, which might not be stored contiguously in memory.</p>
<p>The resulting machine code is often complex and slow.</p>
</div>
<div class="section" id="just-in-time-compilation">
<h4><span class="section-number">13.3.2.3. </span>Just-in-time compilation<a class="headerlink" href="#just-in-time-compilation" title="Permalink to this headline">¶</a></h4>
<p>Just-in-time (JIT) compilation is an alternative approach that marries some of
the advantages of AOT compilation and interpreted languages.</p>
<p>The basic idea is that functions for specific tasks are compiled as requested.</p>
<p>As long as the compiler has enough information about what the function does,
it can in principle generate efficient machine code.</p>
<p>In some instances, all the information is supplied by the programmer.</p>
<p>In other cases, the compiler will attempt to infer missing information on the fly based on usage.</p>
<p>Through this approach, computing environments built around JIT compilers aim to</p>
<ul class="simple">
<li><p>provide all the benefits of high level languages discussed above and, at the same time,</p></li>
<li><p>produce efficient instruction sets when functions are compiled down to machine code</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="jit-compilation-in-julia">
<h2><a class="toc-backref" href="#id5"><span class="section-number">13.4. </span>JIT Compilation in Julia</a><a class="headerlink" href="#jit-compilation-in-julia" title="Permalink to this headline">¶</a></h2>
<p>JIT compilation is the approach used by Julia.</p>
<p>In an ideal setting, all information necessary to generate efficient native machine code is supplied or inferred.</p>
<p>In such a setting, Julia will be on par with machine code from low level languages.</p>
<div class="section" id="an-example">
<h3><span class="section-number">13.4.1. </span>An Example<a class="headerlink" href="#an-example" title="Permalink to this headline">¶</a></h3>
<p>Consider the function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">8</span><span class="n">b</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span>
    <span class="k">return</span> <span class="mi">7</span><span class="n">y</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<p>Suppose we call <code class="docutils literal notranslate"><span class="pre">f</span></code> with integer arguments (e.g., <code class="docutils literal notranslate"><span class="pre">z</span> <span class="pre">=</span> <span class="pre">f(1,</span> <span class="pre">2)</span></code>).</p>
<p>The JIT compiler now knows the types of <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>.</p>
<p>Moreover, it can infer types for other variables inside the function</p>
<ul class="simple">
<li><p>e.g., <code class="docutils literal notranslate"><span class="pre">y</span></code> will also be an integer</p></li>
</ul>
<p>It then compiles a specialized version of the function to handle integers and
stores it in memory.</p>
<p>We can view the corresponding machine code using the &#64;code_native macro</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">f</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[20]:2 within `f`
; │┌ @ int.jl:87 within `+`
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">(</span>%rdi,%rsi,<span class=" -Color -Color-Yellow">8)</span>, %rcx
; │└
; │┌ @ intfuncs.jl:312 within `literal_pow`
; ││┌ @ int.jl:88 within `*`
	<span class=" -Color -Color-Bold">imulq</span>	%rcx, %rcx
; │└└
; │ @ In[20]:3 within `f`
; │┌ @ int.jl:88 within `*`
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">(</span>,%rcx,<span class=" -Color -Color-Yellow">8)</span>, %rax
	<span class=" -Color -Color-Bold">subq</span>	%rcx, %rax
; │└
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>If we now call <code class="docutils literal notranslate"><span class="pre">f</span></code> again, but this time with floating point arguments, the JIT compiler will once more infer types for the other variables inside the function.</p>
<ul class="simple">
<li><p>e.g., <code class="docutils literal notranslate"><span class="pre">y</span></code> will also be a float</p></li>
</ul>
<p>It then compiles a new version to handle this type of argument.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">f</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[20]:1 within `f`
	<span class=" -Color -Color-Bold">movabsq</span>	$.rodata.cst8, %rax
; │ @ In[20]:2 within `f`
; │┌ @ promotion.jl:380 within `*` @ float.jl:405
	<span class=" -Color -Color-Bold">vmulsd</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %xmm1, %xmm1
; │└
; │┌ @ float.jl:399 within `+`
	<span class=" -Color -Color-Bold">vaddsd</span>	%xmm0, %xmm1, %xmm0
; │└
; │┌ @ intfuncs.jl:312 within `literal_pow`
; ││┌ @ float.jl:405 within `*`
	<span class=" -Color -Color-Bold">vmulsd</span>	%xmm0, %xmm0, %xmm0
	<span class=" -Color -Color-Bold">movabsq</span>	<span class=" -Color -Color-Yellow">$139855812622880</span>, %rax          # imm = 0x7F32B807FA20
; │└└
; │ @ In[20]:3 within `f`
; │┌ @ promotion.jl:380 within `*` @ float.jl:405
	<span class=" -Color -Color-Bold">vmulsd</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %xmm0, %xmm0
; │└
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>Subsequent calls using either floats or integers are now routed to the appropriate compiled code.</p>
</div>
<div class="section" id="potential-problems">
<h3><span class="section-number">13.4.2. </span>Potential Problems<a class="headerlink" href="#potential-problems" title="Permalink to this headline">¶</a></h3>
<p>In some senses, what we saw above was a best case scenario.</p>
<p>Sometimes the JIT compiler produces messy, slow machine code.</p>
<p>This happens when type inference fails or the compiler has insufficient information to optimize effectively.</p>
<p>The next section looks at situations where these problems arise and how to get around them.</p>
</div>
</div>
<div class="section" id="fast-and-slow-julia-code">
<h2><a class="toc-backref" href="#id6"><span class="section-number">13.5. </span>Fast and Slow Julia Code</a><a class="headerlink" href="#fast-and-slow-julia-code" title="Permalink to this headline">¶</a></h2>
<p>To summarize what we’ve learned so far, Julia provides a platform for generating highly efficient machine code with relatively little effort by combining</p>
<ol class="simple">
<li><p>JIT compilation</p></li>
<li><p>Optional type declarations and type inference to pin down the types of variables and hence compile efficient code</p></li>
<li><p>Multiple dispatch to facilitate specialization and optimization of compiled code for different data types</p></li>
</ol>
<p>But the process is not flawless, and hiccups can occur.</p>
<p>The purpose of this section is to highlight potential issues and show you how
to circumvent them.</p>
<div class="section" id="benchmarktools">
<h3><span class="section-number">13.5.1. </span>BenchmarkTools<a class="headerlink" href="#benchmarktools" title="Permalink to this headline">¶</a></h3>
<p>The main Julia package for benchmarking is <a class="reference external" href="https://www.github.com/JuliaCI/BenchmarkTools.jl">BenchmarkTools.jl</a>.</p>
<p>Below, we’ll use the <code class="docutils literal notranslate"><span class="pre">&#64;btime</span></code> macro it exports to evaluate the performance of Julia code.</p>
<p>As mentioned in an <a class="reference internal" href="testing.html"><span class="doc">earlier lecture</span></a>, we can also save benchmark results to a file and guard against performance regressions in code.</p>
<p>For more, see the package docs.</p>
</div>
<div class="section" id="global-variables">
<h3><span class="section-number">13.5.2. </span>Global Variables<a class="headerlink" href="#global-variables" title="Permalink to this headline">¶</a></h3>
<p>Global variables are names assigned to values outside of any function or type definition.</p>
<p>The are convenient and novice programmers typically use them with abandon.</p>
<p>But global variables are also dangerous, especially in medium to large size programs, since</p>
<ul class="simple">
<li><p>they can affect what happens in any part of your program</p></li>
<li><p>they can be changed by any function</p></li>
</ul>
<p>This makes it much harder to be certain about what some  small part of a given piece of code actually commands.</p>
<p>Here’s a <a class="reference external" href="http://wiki.c2.com/?GlobalVariablesAreBad">useful discussion on the topic</a>.</p>
<p>When it comes to JIT compilation, global variables create further problems.</p>
<p>The reason is that the compiler can never be sure of the type of the global
variable, or even that the type will stay constant while a given function runs.</p>
<p>To illustrate, consider this code, where <code class="docutils literal notranslate"><span class="pre">b</span></code> is global</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="k">function</span> <span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">b</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1_000_000</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">tmp</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>g (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>The code executes relatively slowly and uses a huge amount of memory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span> <span class="n">BenchmarkTools</span>

<span class="nd">@btime</span> <span class="n">g</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  48.766 ms (3000001 allocations: 45.78 MiB)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.000001e6
</pre></div>
</div>
</div>
</div>
<p>If you look at the corresponding machine code you will see that it’s a mess.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">g</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[23]:2 within `g`
	<span class=" -Color -Color-Bold">pushq</span>	%rbp
	<span class=" -Color -Color-Bold">movq</span>	%rsp, %rbp
	<span class=" -Color -Color-Bold">pushq</span>	%r15
	<span class=" -Color -Color-Bold">pushq</span>	%r14
	<span class=" -Color -Color-Bold">pushq</span>	%r13
	<span class=" -Color -Color-Bold">pushq</span>	%r12
	<span class=" -Color -Color-Bold">pushq</span>	%rbx
	<span class=" -Color -Color-Bold">andq</span>	<span class=" -Color -Color-Yellow">$-32</span>, %rsp
	<span class=" -Color -Color-Bold">subq</span>	<span class=" -Color -Color-Yellow">$96</span>, %rsp
	<span class=" -Color -Color-Bold">vmovsd</span>	%xmm0, <span class=" -Color -Color-Yellow">8(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_system_image_data, %r14
	<span class=" -Color -Color-Bold">vxorps</span>	%xmm0, %xmm0, %xmm0
	<span class=" -Color -Color-Bold">vmovaps</span>	%ymm0, <span class=" -Color -Color-Yellow">32(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">$0</span>, <span class=" -Color -Color-Yellow">64(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%fs:<span class=" -Color -Color-Yellow">0</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">-8(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %rcx
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">$12</span>, <span class=" -Color -Color-Yellow">32(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">(</span>%rcx<span class=" -Color -Color-Yellow">)</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">40(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">32(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">(</span>%rcx<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rcx, <span class=" -Color -Color-Yellow">(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">16(</span>%rcx<span class=" -Color -Color-Yellow">)</span>, %rdi
	<span class=" -Color -Color-Bold">movabsq</span>	<span class=" -Color -Color-Yellow">$139856197265205</span>, %rax          # imm = 0x7F32CEF52735
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$1392</span>, %esi                     # imm = 0x570
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$16</span>, %edx
	<span class=" -Color -Color-Bold">vzeroupper</span>
	<span class=" -Color -Color-Bold">callq</span>	*%rax
	<span class=" -Color -Color-Bold">movq</span>	%rax, %rbx
	<span class=" -Color -Color-Bold">movq</span>	%r14, <span class=" -Color -Color-Yellow">-8(</span>%rax<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">vmovsd</span>	<span class=" -Color -Color-Yellow">8(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %xmm0                  # xmm0 = mem[0],zero
	<span class=" -Color -Color-Bold">vmovsd</span>	%xmm0, <span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$1000000</span>, %r12d                 # imm = 0xF4240
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">16(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %r15
	<span class=" -Color -Color-Bold">nopl</span>	<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; │ @ In[23] within `g`
L160:
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_system_image_data, %r14
; │ @ In[23]:6 within `g`
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">-417524792(</span>%r14<span class=" -Color -Color-Yellow">)</span>, %r13
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rax
; │┌ @ operators.jl:655 within `+`
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">16(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %rdi
	<span class=" -Color -Color-Bold">movq</span>	%r13, <span class=" -Color -Color-Yellow">64(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rbx, <span class=" -Color -Color-Yellow">56(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$1392</span>, %esi                     # imm = 0x570
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$16</span>, %edx
	<span class=" -Color -Color-Bold">movabsq</span>	<span class=" -Color -Color-Yellow">$139856197265205</span>, %rax          # imm = 0x7F32CEF52735
	<span class=" -Color -Color-Bold">callq</span>	*%rax
	<span class=" -Color -Color-Bold">movq</span>	%r14, <span class=" -Color -Color-Yellow">-8(</span>%rax<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">vmovsd</span>	<span class=" -Color -Color-Yellow">8(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %xmm0                  # xmm0 = mem[0],zero
	<span class=" -Color -Color-Bold">vmovsd</span>	%xmm0, <span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">48(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rbx, <span class=" -Color -Color-Yellow">16(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">24(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_system_image_data, %r14
	<span class=" -Color -Color-Bold">movq</span>	%r14, %rdi
	<span class=" -Color -Color-Bold">movq</span>	%r15, %rsi
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$2</span>, %edx
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_apply_generic, %rbx
	<span class=" -Color -Color-Bold">callq</span>	*%rbx
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">48(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">16(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%r13, <span class=" -Color -Color-Yellow">24(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%r14, %rdi
	<span class=" -Color -Color-Bold">movq</span>	%r15, %rsi
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$2</span>, %edx
	<span class=" -Color -Color-Bold">callq</span>	*%rbx
	<span class=" -Color -Color-Bold">movq</span>	%rax, %rbx
; │└
; │┌ @ range.jl:837 within `iterate`
; ││┌ @ promotion.jl:468 within `==`
	<span class=" -Color -Color-Bold">decq</span>	%r12
; │└└
	<span class=" -Color -Color-Bold">jne</span>	L160
; │ @ In[23] within `g`
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">40(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rcx
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">(</span>%rcx<span class=" -Color -Color-Yellow">)</span>
; │ @ In[23]:8 within `g`
	<span class=" -Color -Color-Bold">movq</span>	%rbx, %rax
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">-40(</span>%rbp<span class=" -Color -Color-Yellow">)</span>, %rsp
	<span class=" -Color -Color-Bold">popq</span>	%rbx
	<span class=" -Color -Color-Bold">popq</span>	%r12
	<span class=" -Color -Color-Bold">popq</span>	%r13
	<span class=" -Color -Color-Bold">popq</span>	%r14
	<span class=" -Color -Color-Bold">popq</span>	%r15
	<span class=" -Color -Color-Bold">popq</span>	%rbp
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopl</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>If we eliminate the global variable like so</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1_000_000</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">tmp</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>g (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<p>then execution speed improves dramatically.  Furthermore, the number of allocations has dropped to zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">g</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  2.673 ms (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.000001e6
</pre></div>
</div>
</div>
</div>
<p>Note that if you called <code class="docutils literal notranslate"><span class="pre">&#64;time</span></code> instead, the first call would be slower as it would need to compile the function.  Conversely, <code class="docutils literal notranslate"><span class="pre">&#64;btime</span></code> discards the first call and runs it multiple times.</p>
<p>More information is available with <code class="docutils literal notranslate"><span class="pre">&#64;benchmark</span></code> instead,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@benchmark</span> <span class="n">g</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>BenchmarkTools.Trial: 1866 samples with 1 evaluation.
 Range (<span class=" -Color -Color-Bold -Color-Bold-Cyan">min</span> … <span class=" -Color -Color-Magenta">max</span>):  <span class=" -Color -Color-Bold -Color-Bold-Cyan">2.673 ms</span> … <span class=" -Color -Color-Magenta">2.762 ms</span>  ┊ GC (min … max): 0.00% … 0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Blue">median</span>):     <span class=" -Color -Color-Bold -Color-Bold-Blue">2.679 ms             </span>┊ GC (median):    0.00%
 Time  (<span class=" -Color -Color-Bold -Color-Bold-Green">mean</span> ± <span class=" -Color -Color-Green">σ</span>):   <span class=" -Color -Color-Bold -Color-Bold-Green">2.678 ms</span> ± <span class=" -Color -Color-Green">5.469 μs</span>  ┊ GC (mean ± σ):  0.00% ± 0.00%

  █              <span class=" -Color -Color-Green"> </span><span class=" -Color -Color-Blue"> </span>                                          
  █▅▃▂▆▃▂▁▁▁▁▃▄▅▄<span class=" -Color -Color-Green">▅</span><span class=" -Color -Color-Blue">▆</span>▅▆▅▅▄▅▄▃▄▃▃▃▃▃▂▂▂▂▂▂▂▂▂▂▂▂▂▂▁▂▁▂▁▂▁▁▁▁▂▂ ▃
  2.67 ms        Histogram: frequency by time       2.69 ms <span class=" -Color -Color-Bold">&lt;</span>

 Memory estimate: <span class=" -Color -Color-Yellow">0 bytes</span>, allocs estimate: <span class=" -Color -Color-Yellow">0</span>.
</pre></div>
</div>
</div>
</div>
<p>Also, the machine code is simple and clean</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">g</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[26]:1 within `g`
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$1000000</span>, %eax                  # imm = 0xF4240
	<span class=" -Color -Color-Bold">vmovapd</span>	%xmm0, %xmm2
	<span class=" -Color -Color-Bold">nopl</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>
; │ @ In[26]:4 within `g`
; │┌ @ operators.jl:655 within `+` @ float.jl:399
L16:
	<span class=" -Color -Color-Bold">vaddsd</span>	%xmm0, %xmm2, %xmm2
	<span class=" -Color -Color-Bold">vaddsd</span>	%xmm1, %xmm2, %xmm2
; │└
; │┌ @ range.jl:837 within `iterate`
; ││┌ @ promotion.jl:468 within `==`
	<span class=" -Color -Color-Bold">decq</span>	%rax
; │└└
	<span class=" -Color -Color-Bold">jne</span>	L16
; │ @ In[26]:6 within `g`
	<span class=" -Color -Color-Bold">vmovapd</span>	%xmm2, %xmm0
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>Now the compiler is certain of types throughout execution of the function and
hence can optimize accordingly.</p>
<p>If global variations are strictly needed (and they almost never are) then you can declare them with a <code class="docutils literal notranslate"><span class="pre">const</span></code> to declare to Julia that the type never changes (the value can).  For example,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">b_const</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="k">function</span> <span class="n">g_const</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">global</span> <span class="n">b_const</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">a</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1_000_000</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">+</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b_const</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">tmp</span>
<span class="k">end</span>
<span class="nd">@btime</span> <span class="n">g_const</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  4.682 ms (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.000001e6
</pre></div>
</div>
</div>
</div>
<p>Now the compiler can again generate efficient machine code.</p>
<p>However, global variables within a function is almost always a bad idea.  Instead, the <code class="docutils literal notranslate"><span class="pre">b_const</span></code> should be passed as a parameter to the function.</p>
</div>
<div class="section" id="composite-types-with-abstract-field-types">
<h3><span class="section-number">13.5.3. </span>Composite Types with Abstract Field Types<a class="headerlink" href="#composite-types-with-abstract-field-types" title="Permalink to this headline">¶</a></h3>
<p>Another scenario that trips up the JIT compiler is when composite types have
fields with abstract types.</p>
<p>We met this issue <a class="reference internal" href="../more_julia/generic_programming.html#spec-field-types"><span class="std std-ref">earlier</span></a>, when we discussed AR(1) models.</p>
<p>Let’s experiment, using, respectively,</p>
<ul class="simple">
<li><p>an untyped field</p></li>
<li><p>a field with abstract type, and</p></li>
<li><p>parametric typing</p></li>
</ul>
<p>As we’ll see, the last of these options gives us the best performance, while still maintaining significant flexibility.</p>
<p>Here’s the untyped case</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">Foo_any</span>
    <span class="n">a</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the case of an abstract type on the field <code class="docutils literal notranslate"><span class="pre">a</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">Foo_abstract</span>
    <span class="n">a</span><span class="o">::</span><span class="kt">Real</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, here’s the parametrically typed case (where the <code class="docutils literal notranslate"><span class="pre">{T</span> <span class="pre">&lt;:</span> <span class="pre">Real}</span></code> is not necessary for performance, and could simply be <code class="docutils literal notranslate"><span class="pre">{T}</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="kt">Foo_concrete</span><span class="p">{</span><span class="kt">T</span> <span class="o">&lt;:</span> <span class="kt">Real</span><span class="p">}</span>
    <span class="n">a</span><span class="o">::</span><span class="kt">T</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>
<p>Now we generate instances</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">fg</span> <span class="o">=</span> <span class="n">Foo_any</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">fa</span> <span class="o">=</span> <span class="n">Foo_abstract</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">fc</span> <span class="o">=</span> <span class="n">Foo_concrete</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Foo_concrete{Float64}(1.0)
</pre></div>
</div>
</div>
</div>
<p>In the last case, concrete type information for the fields is embedded in the object</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">typeof</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Foo_concrete{Float64}
</pre></div>
</div>
</div>
</div>
<p>This is significant because such information is detected by the compiler.</p>
<div class="section" id="timing">
<h4><span class="section-number">13.5.3.1. </span>Timing<a class="headerlink" href="#timing" title="Permalink to this headline">¶</a></h4>
<p>Here’s a function that uses the field <code class="docutils literal notranslate"><span class="pre">a</span></code> of our objects</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">f</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">a</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1_000_000</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">foo</span><span class="o">.</span><span class="n">a</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">tmp</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>f (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
<p>Let’s try timing our code, starting with the case without any constraints:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">fg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  26.843 ms (1999489 allocations: 30.51 MiB)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000001e6
</pre></div>
</div>
</div>
</div>
<p>The timing is not very impressive.</p>
<p>Here’s the nasty looking machine code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">f</span><span class="p">(</span><span class="n">fg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[36]:1 within `f`
	<span class=" -Color -Color-Bold">pushq</span>	%rbp
	<span class=" -Color -Color-Bold">pushq</span>	%r15
	<span class=" -Color -Color-Bold">pushq</span>	%r14
	<span class=" -Color -Color-Bold">pushq</span>	%r13
	<span class=" -Color -Color-Bold">pushq</span>	%r12
	<span class=" -Color -Color-Bold">pushq</span>	%rbx
	<span class=" -Color -Color-Bold">subq</span>	<span class=" -Color -Color-Yellow">$56</span>, %rsp
	<span class=" -Color -Color-Bold">vxorps</span>	%xmm0, %xmm0, %xmm0
	<span class=" -Color -Color-Bold">vmovaps</span>	%xmm0, <span class=" -Color -Color-Yellow">(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">$0</span>, <span class=" -Color -Color-Yellow">16(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%fs:<span class=" -Color -Color-Yellow">0</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">-8(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %rcx
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">$4</span>, <span class=" -Color -Color-Yellow">(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">(</span>%rcx<span class=" -Color -Color-Yellow">)</span>, %rax
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">8(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rsp, %rax
	<span class=" -Color -Color-Bold">movq</span>	%rcx, <span class=" -Color -Color-Yellow">32(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">(</span>%rcx<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">(</span>%rdi<span class=" -Color -Color-Yellow">)</span>, %r13
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$1</span>, %ebx
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_box_int64, %rbp
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_apply_generic, %r12
	<span class=" -Color -Color-Bold">movabsq</span>	$jl_system_image_data, %r14
	<span class=" -Color -Color-Bold">leaq</span>	<span class=" -Color -Color-Yellow">40(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %r15
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; │ @ In[36]:4 within `f`
L128:
	<span class=" -Color -Color-Bold">movq</span>	%rbx, %rdi
	<span class=" -Color -Color-Bold">callq</span>	*%rbp
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">16(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%rax, <span class=" -Color -Color-Yellow">40(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%r13, <span class=" -Color -Color-Yellow">48(</span>%rsp<span class=" -Color -Color-Yellow">)</span>
	<span class=" -Color -Color-Bold">movq</span>	%r14, %rdi
	<span class=" -Color -Color-Bold">movq</span>	%r15, %rsi
	<span class=" -Color -Color-Bold">movl</span>	<span class=" -Color -Color-Yellow">$2</span>, %edx
	<span class=" -Color -Color-Bold">callq</span>	*%r12
; │┌ @ range.jl:837 within `iterate`
	<span class=" -Color -Color-Bold">incq</span>	%rbx
; ││┌ @ promotion.jl:468 within `==`
	<span class=" -Color -Color-Bold">cmpq</span>	<span class=" -Color -Color-Yellow">$1000001</span>, %rbx                  # imm = 0xF4241
; │└└
	<span class=" -Color -Color-Bold">jne</span>	L128
; │ @ In[36] within `f`
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">8(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rcx
	<span class=" -Color -Color-Bold">movq</span>	<span class=" -Color -Color-Yellow">32(</span>%rsp<span class=" -Color -Color-Yellow">)</span>, %rdx
	<span class=" -Color -Color-Bold">movq</span>	%rcx, <span class=" -Color -Color-Yellow">(</span>%rdx<span class=" -Color -Color-Yellow">)</span>
; │ @ In[36]:6 within `f`
	<span class=" -Color -Color-Bold">addq</span>	<span class=" -Color -Color-Yellow">$56</span>, %rsp
	<span class=" -Color -Color-Bold">popq</span>	%rbx
	<span class=" -Color -Color-Bold">popq</span>	%r12
	<span class=" -Color -Color-Bold">popq</span>	%r13
	<span class=" -Color -Color-Bold">popq</span>	%r14
	<span class=" -Color -Color-Bold">popq</span>	%r15
	<span class=" -Color -Color-Bold">popq</span>	%rbp
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>The abstract case is almost identical,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">fa</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  27.243 ms (1999489 allocations: 30.51 MiB)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000001e6
</pre></div>
</div>
</div>
</div>
<p>Note the large memory footprint.</p>
<p>The machine code is also long and complex, although we omit details.</p>
<p>Finally, let’s look at the parametrically typed version</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">f</span><span class="p">(</span><span class="o">$</span><span class="n">fc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  1.700 ns (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.000001e6
</pre></div>
</div>
</div>
</div>
<p>Which is improbably small - since a runtime of 1-2 nanoseconds without any allocations suggests no computations really took place.</p>
<p>A hint is in the simplicity of the corresponding machine code</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@code_native</span> <span class="n">f</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[36]:4 within `f`
; │┌ @ promotion.jl:379 within `+` @ float.jl:399
	<span class=" -Color -Color-Bold">vmovsd</span>	<span class=" -Color -Color-Yellow">(</span>%rdi<span class=" -Color -Color-Yellow">)</span>, %xmm0                   # xmm0 = mem[0],zero
	<span class=" -Color -Color-Bold">movabsq</span>	$.rodata.cst8, %rax
	<span class=" -Color -Color-Bold">vaddsd</span>	<span class=" -Color -Color-Yellow">(</span>%rax<span class=" -Color -Color-Yellow">)</span>, %xmm0, %xmm0
; │└
; │ @ In[36]:6 within `f`
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>This machine code has none of the hallmark assembly instructions associated with a loop, in particular loops (e.g. <code class="docutils literal notranslate"><span class="pre">for</span></code> in julia) end up as jumps in the machine code (e.g. <code class="docutils literal notranslate"><span class="pre">jne</span></code>).</p>
<p>Here, the compiler was smart enough to realize that only the final step in the loop matters, i.e. it could generate the equivalent to <code class="docutils literal notranslate"><span class="pre">f(a)</span> <span class="pre">=</span> <span class="pre">1_000_000</span> <span class="pre">+</span> <span class="pre">foo.a</span></code> and then it can return that directly and skip the loop.  These sorts of code optimizations are only possible if the compiler is able to use a great deal of information about the types.</p>
<p>Finally, note that if we compile a slightly different version of the function, which doesn’t actually return the value</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">f_no_return</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mi">1_000_000</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">foo</span><span class="o">.</span><span class="n">a</span>
    <span class="k">end</span>
<span class="k">end</span>
<span class="nd">@code_native</span> <span class="n">f_no_return</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>	.text
; ┌ @ In[42]:3 within `f_no_return`
	<span class=" -Color -Color-Bold">retq</span>
	<span class=" -Color -Color-Bold">nopw</span>	%cs:<span class=" -Color -Color-Yellow">(</span>%rax,%rax<span class=" -Color -Color-Yellow">)</span>
; └
</pre></div>
</div>
</div>
</div>
<p>We see that the code is even simpler.  In effect, if figured out that because <code class="docutils literal notranslate"><span class="pre">tmp</span></code> wasn’t returned, and the <code class="docutils literal notranslate"><span class="pre">foo.a</span></code> could have no side effects (since it knows the type of <code class="docutils literal notranslate"><span class="pre">a</span></code>), that it doesn’t even need to execute any of the code in the function.</p>
</div>
</div>
<div class="section" id="type-inference">
<h3><span class="section-number">13.5.4. </span>Type Inference<a class="headerlink" href="#type-inference" title="Permalink to this headline">¶</a></h3>
<p>Consider the following function, which essentially does the same job as Julia’s <code class="docutils literal notranslate"><span class="pre">sum()</span></code> function but acts only on floating point data</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">sum_float_array</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="o">&lt;:</span><span class="kt">Number</span><span class="p">})</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">eachindex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">sum</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sum_float_array (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>Calls to this function run very quickly</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x_range</span> <span class="o">=</span> <span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">100_000</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span>
<span class="n">typeof</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Vector{Float64} (alias for Array{Float64, 1})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">sum_float_array</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  133.699 μs (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50000.0
</pre></div>
</div>
</div>
</div>
<p>When Julia compiles this function, it knows that the data passed in as <code class="docutils literal notranslate"><span class="pre">x</span></code> will be an array of 64 bit floats.  Hence it’s known to the compiler that the relevant method for <code class="docutils literal notranslate"><span class="pre">+</span></code> is always addition of floating point numbers.</p>
<p>But consider a version without that type annotation</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">sum_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">eachindex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">sum</span>
<span class="k">end</span>
<span class="nd">@btime</span> <span class="n">sum_array</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  133.600 μs (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50000.0
</pre></div>
</div>
</div>
</div>
<p>Note that this has the same running time as the one with the explicit types.  In julia, there is (almost never) performance gain from declaring types, and if anything they can make things worse by limited the potential for specialized algorithms.  See <a class="reference internal" href="../more_julia/generic_programming.html"><span class="doc">generic programming</span></a> for more.</p>
<p>As an example within Julia code, look at the built-in sum for array</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">sum</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  11.600 μs (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50000.00000000001
</pre></div>
</div>
</div>
</div>
<p>Versus the underlying range</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">sum</span><span class="p">(</span><span class="o">$</span><span class="n">x_range</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  115.996 ns (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50000.0
</pre></div>
</div>
</div>
</div>
<p>Note that the difference in speed is enormous—suggesting it is better to keep things in their more structured forms as long as possible.  You can check the underlying source used for this with <code class="docutils literal notranslate"><span class="pre">&#64;which</span> <span class="pre">sum(x_range)</span></code> to see the specialized algorithm used.</p>
<div class="section" id="type-inferences">
<h4><span class="section-number">13.5.4.1. </span>Type Inferences<a class="headerlink" href="#type-inferences" title="Permalink to this headline">¶</a></h4>
<p>Here’s the same function minus the type annotation in the function signature</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span> <span class="n">sum_array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">sum</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">eachindex</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">sum</span> <span class="o">+=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">end</span>
    <span class="k">return</span> <span class="n">sum</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sum_array (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>When we run it with the same array of floating point numbers it executes at a
similar speed as the function with type information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">sum_array</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  133.600 μs (0 allocations: 0 bytes)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>50000.0
</pre></div>
</div>
</div>
</div>
<p>The reason is that when <code class="docutils literal notranslate"><span class="pre">sum_array()</span></code> is first called on a vector of a given
data type, a newly compiled version of the function is produced to handle that
type.</p>
<p>In this case, since we’re calling the function on a vector of floats, we get a compiled version of the function with essentially the same internal representation as <code class="docutils literal notranslate"><span class="pre">sum_float_array()</span></code>.</p>
</div>
<div class="section" id="an-abstract-container">
<h4><span class="section-number">13.5.4.2. </span>An Abstract Container<a class="headerlink" href="#an-abstract-container" title="Permalink to this headline">¶</a></h4>
<p>Things get tougher for the interpreter when the data type within the array is imprecise.</p>
<p>For example, the following snippet creates an array where the element type is <code class="docutils literal notranslate"><span class="pre">Any</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="kt">Any</span><span class="p">[</span> <span class="mi">1</span><span class="o">/</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">:</span><span class="mf">1e6</span> <span class="p">];</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">eltype</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Any
</pre></div>
</div>
</div>
</div>
<p>Now summation is much slower and memory management is less efficient.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="nd">@btime</span> <span class="n">sum_array</span><span class="p">(</span><span class="o">$</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  20.326 ms (1000000 allocations: 15.26 MiB)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14.392726722864989
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="further-comments">
<h2><a class="toc-backref" href="#id7"><span class="section-number">13.6. </span>Further Comments</a><a class="headerlink" href="#further-comments" title="Permalink to this headline">¶</a></h2>
<p>Here are some final comments on performance.</p>
<div class="section" id="summary-and-tips">
<h3><span class="section-number">13.6.1. </span>Summary and Tips<a class="headerlink" href="#summary-and-tips" title="Permalink to this headline">¶</a></h3>
<p>Use functions to segregate operations into logically distinct blocks.</p>
<p>Data types will be determined at function boundaries.</p>
<p>If types are not supplied then they will be inferred.</p>
<p>If types are stable and can be inferred effectively your functions will run fast.</p>
</div>
<div class="section" id="further-reading">
<h3><span class="section-number">13.6.2. </span>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h3>
<p>A good next stop for further reading is the <a class="reference external" href="https://docs.julialang.org/en/v1/manual/performance-tips/">relevant part</a> of the Julia documentation.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.7"
        },
        kernelOptions: {
            kernelName: "julia-1.7",
            path: "./software_engineering"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.7'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="sidebar bd-sidebar inactive" id="site-navigation">

                <div class="sidebar__header">


                    Contents

                </div>

                <nav class="sidebar__nav" id="sidebar-nav" aria-label="Main navigation">
                    <p class="caption">
 <span class="caption-text">
  Getting Started with Julia
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/getting_started.html">
   1. Setting up Your Julia Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/julia_by_example.html">
   2. Introductory Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/julia_essentials.html">
   3. Julia Essentials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/fundamental_types.html">
   4. Arrays, Tuples, Ranges, and Other Fundamental Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/introduction_to_types.html">
   5. Introduction to Types and Generic Programming
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Package Ecosystem
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/generic_programming.html">
   6. Generic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/general_packages.html">
   7. General Purpose Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/data_statistical_packages.html">
   8. Data and Statistics Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/optimization_solver_packages.html">
   9. Solvers, Optimizers, and Automatic Differentiation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Software Engineering
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="tools_editors.html">
   10. Visual Studio Code and Other Tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="version_control.html">
   11. GitHub, Version Control and Collaboration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="testing.html">
   12. Packages, Testing, and Continuous Integration
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   13. The Need for Speed
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/geom_series.html">
   14. Geometric Series for Elementary Economics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/linear_algebra.html">
   15. Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/orth_proj.html">
   16. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/lln_clt.html">
   17. LLN and CLT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/linear_models.html">
   18. Linear State Space Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/finite_markov.html">
   19. Finite Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/stationary_densities.html">
   20. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/kalman.html">
   21. A First Look at the Kalman Filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/numerical_linear_algebra.html">
   22. Numerical Linear Algebra and Factorizations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/iterative_methods_sparsity.html">
   23. Krylov Methods and Matrix Conditioning
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dynamic Programming
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/short_path.html">
   24. Shortest Paths
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/mccall_model.html">
   25. Job Search I: The McCall Search Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/mccall_model_with_separation.html">
   26. Job Search II: Search and Separation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/wald_friedman.html">
   27. A Problem that Stumped Milton Friedman
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/odu.html">
   28. Job Search III: Search with Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/career.html">
   29. Job Search IV: Modeling Career Choice
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/jv.html">
   30. Job Search V: On-the-Job Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/optgrowth.html">
   31. Optimal Growth I: The Stochastic Optimal Growth Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/coleman_policy_iter.html">
   32. Optimal Growth II: Time Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/egm_policy_iter.html">
   33. Optimal Growth III: The Endogenous Grid Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/lqcontrol.html">
   34. LQ Dynamic Programming Problems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/perm_income.html">
   35. Optimal Savings I: The Permanent Income Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/perm_income_cons.html">
   36. Optimal Savings II: LQ Techniques
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/smoothing.html">
   37. Consumption and Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/ifp.html">
   38. Optimal Savings III: Occasionally Binding Constraints
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/robustness.html">
   39. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/discrete_dp.html">
   40. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Modeling in Continuous Time
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../continuous_time/seir_model.html">
   41. Modeling COVID 19 with Differential Equations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../continuous_time/covid_sde.html">
   42. Modeling Shocks in COVID 19 with Stochastic Differential Equations
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/schelling.html">
   43. Schelling’s Segregation Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/lake_model.html">
   44. A Lake Model of Employment and Unemployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/rational_expectations.html">
   45. Rational Expectations Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/markov_perf.html">
   46. Markov Perfect Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/markov_asset.html">
   47. Asset Pricing I: Finite State Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/lucas_model.html">
   48. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/harrison_kreps.html">
   49. Asset Pricing III:  Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/uncertainty_traps.html">
   50. Uncertainty Traps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/aiyagari.html">
   51. The Aiyagari Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/arellano.html">
   52. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/matsuyama.html">
   53. Globalization and Cycles
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/arma.html">
   54. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/estspec.html">
   55. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/additive_functionals.html">
   56. Additive Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/multiplicative_functionals.html">
   57. Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/lu_tricks.html">
   58. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/classical_filtering.html">
   59. Classical Filtering With Linear Algebra
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming_squared/dyn_stack.html">
   60. Dynamic Stackelberg Problems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming_squared/lqramsey.html">
   61. Optimal Taxation in an LQ Economy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming_squared/opt_tax_recur.html">
   62. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming_squared/amss.html">
   63. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../about_lectures.html">
   64. About these Lectures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../troubleshooting.html">
   65. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../zreferences.html">
   66. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../status.html">
   67. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="toolbar">

            <div class="toolbar__inner">

                <ul class="toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="../intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                    <!-- <li class="btn__search">
                        <form action="../search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off">
                            <i data-feather="search"></i>
                        </form>
                    </li> -->
                </ul>

                <ul class="toolbar__links">
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="_notebooks/software_engineering/need_for_speed.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li data-tippy-content="Download PDF" onClick="window.print()"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-julia.myst/tree/main/lectures/software_engineering/need_for_speed.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://mybinder.org/v2/gh/QuantEcon/lecture-julia.notebooks/main?urlpath=tree/software_engineering/need_for_speed.ipynb">BinderHub</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-julia.notebooks" data-urlpath="tree/lecture-julia.notebooks/software_engineering/need_for_speed.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://mybinder.org/v2/gh/QuantEcon/lecture-julia.notebooks/main?urlpath=tree/software_engineering/need_for_speed.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "software_engineering/need_for_speed";
                const repoURL = "https://github.com/QuantEcon/lecture-julia.notebooks";
                const urlPath = "tree/lecture-julia.notebooks/software_engineering/need_for_speed.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-54984338-8', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>