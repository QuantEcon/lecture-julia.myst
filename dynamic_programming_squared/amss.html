
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>66. Optimal Taxation without State-Contingent Debt &#8212; Quantitative Economics with Julia</title>
    <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://unpkg.com/tippy.js@6.3.1/dist/tippy-bundle.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    
        <script>
            MathJax = {
            loader: {load: ['[tex]/boldsymbol', '[tex]/textmacros']},
            tex: {
                packages: {'[+]': ['boldsymbol', 'textmacros']},
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                processEscapes: true,
                macros: {
                    "argmax" : "arg\\,max",
                    "argmin" : "arg\\,min",
                    "col"    : "col",
                    "Span"   :  "span",
                    "epsilon": "\\varepsilon",
                    "EE": "\\mathbb{E}",
                    "PP": "\\mathbb{P}",
                    "RR": "\\mathbb{R}",
                    "NN": "\\mathbb{N}",
                    "ZZ": "\\mathbb{Z}",
                    "aA": "\\mathcal{A}",
                    "bB": "\\mathcal{B}",
                    "cC": "\\mathcal{C}",
                    "dD": "\\mathcal{D}",
                    "eE": "\\mathcal{E}",
                    "fF": "\\mathcal{F}",
                    "gG": "\\mathcal{G}",
                    "hH": "\\mathcal{H}",
                }
            },
            svg: {
                fontCache: 'global',
                scale: 0.92,
                displayAlign: "center",
            },
            };
        </script>
    
    
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/quantecon-book-theme.1ef59f8f4e91ec8319176e8479c6af4e.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">


    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script src="../_static/quantecon-book-theme.15b0c36fffe88f468997fa7b698991d3.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"tex": {"macros": {"argmax": "arg\\,max", "argmin": "arg\\,min"}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js"></script>
    <link rel="canonical" href="https://julia.quantecon.org/dynamic_programming_squared/amss.html" />
    <link rel="shortcut icon" href="../_static/lectures-favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="67. About these Lectures" href="../about_lectures.html" />
    <link rel="prev" title="65. Optimal Taxation with State-Contingent Debt" href="opt_tax_recur.html" />

<!-- Normal Meta Tags -->
<meta name="author" context="Jesse Perla &amp; Thomas J. Sargent &amp; John Stachurski" />
<meta name="keywords" content="Julia, QuantEcon, Quantitative Economics, Economics, Sloan, Alfred P. Sloan Foundation, Tom J. Sargent, John Stachurski" />
<meta name="description" content=This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia. />

<!-- Twitter tags -->
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@quantecon" />
<meta name="twitter:title" content="Optimal Taxation without State-Contingent Debt"/>
<meta name="twitter:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia.">
<meta name="twitter:creator" content="@quantecon">
<meta name="twitter:image" content="https://assets.quantecon.org/img/qe-twitter-logo.png">

<!-- Opengraph tags -->
<meta property="og:title" content="Optimal Taxation without State-Contingent Debt" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://julia.quantecon.org/dynamic_programming_squared/amss.html" />
<meta property="og:image" content="https://assets.quantecon.org/img/qe-og-logo.png" />
<meta property="og:description" content="This website presents a set of lectures on quantitative economic modeling, designed and written by Jesse Perla, Thomas J. Sargent and John Stachurski. The language instruction is Julia." />
<meta property="og:site_name" content="Quantitative Economics with Julia" />
<meta name="theme-color" content="#ffffff" />

  </head>
<body>


    <span id="top"></span>

    <div class="qe-wrapper">

        <div class="qe-main">

            <div class="qe-page" id=dynamic_programming_squared/amss>

                <div class="qe-page__toc">

                    <div class="inner">

                        
                        <div class="qe-page__toc-header">
                            On this page
                        </div>


                        <nav id="bd-toc-nav" class="qe-page__toc-nav">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   66.1. Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#competitive-equilibrium-with-distorting-taxes">
   66.2. Competitive Equilibrium with Distorting Taxes
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#risk-free-one-period-debt-only">
     66.2.1. Risk-free One-Period Debt Only
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison-with-lucas-stokey-economy">
     66.2.2. Comparison with Lucas-Stokey Economy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ramsey-problem-without-state-contingent-debt">
     66.2.3. Ramsey Problem Without State-contingent Debt
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#lagrangian-formulation">
       66.2.3.1. Lagrangian Formulation
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#some-calculations">
     66.2.4. Some Calculations
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#recursive-version-of-amss-model">
   66.3. Recursive Version of AMSS Model
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#recasting-state-variables">
     66.3.1. Recasting State Variables
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#measurability-constraints">
     66.3.2. Measurability Constraints
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#two-bellman-equations">
     66.3.3. Two Bellman Equations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#martingale-supercedes-state-variable-degeneracy">
     66.3.4. Martingale Supercedes State-Variable Degeneracy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#absence-of-state-variable-degeneracy">
     66.3.5. Absence of State Variable Degeneracy
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#digression-on-nonnegative-transfers">
     66.3.6. Digression on Nonnegative Transfers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#code">
     66.3.7. Code
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#examples">
   66.4. Examples
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#anticipated-one-period-war">
     66.4.1. Anticipated One-Period War
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#perpetual-war-alert">
       66.4.1.1. Perpetual War Alert
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                            <p class="logo">
                                
                                    
                                    <a href=https://quantecon.org><img src="../_static/qe-logo-large.png" class="logo" alt="logo"></a>
                                    
                                
                            </p>

                            <p class="powered">Powered by <a href="https://jupyterbook.org/">Jupyter Book</a></p>

                        </nav>

                        <div class="qe-page__toc-footer">
                            
                            
                            <p><a href="#top"><strong>Back to top</strong></a></p>
                        </div>

                    </div>

                </div>

                <div class="qe-page__header">

                    <div class="qe-page__header-copy">

                        <p class="qe-page__header-heading"><a href="../intro.html">Quantitative Economics with Julia</a></p>

                        <p class="qe-page__header-subheading">Optimal Taxation without State-Contingent Debt</p>

                    </div>

                    <p class="qe-page__header-authors">Jesse Perla & Thomas J. Sargent & John Stachurski</p>

                </div> <!-- .page__header -->



                
                <main class="qe-page__content" role="main">
                    
                    <div>
                        
  <div id="qe-notebook-header" style="text-align:right;">
        <a href="https://quantecon.org/" title="quantecon.org">
                <img style="width:250px;display:inline;" src="https://assets.quantecon.org/img/qe-menubar-logo.svg" alt="QuantEcon">
        </a>
</div><div class="tex2jax_ignore mathjax_ignore section" id="optimal-taxation-without-state-contingent-debt">
<h1><a class="toc-backref" href="#id10"><span class="section-number">66. </span>Optimal Taxation without State-Contingent Debt</a><a class="headerlink" href="#optimal-taxation-without-state-contingent-debt" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#optimal-taxation-without-state-contingent-debt" id="id10">Optimal Taxation without State-Contingent Debt</a></p>
<ul>
<li><p><a class="reference internal" href="#overview" id="id11">Overview</a></p></li>
<li><p><a class="reference internal" href="#competitive-equilibrium-with-distorting-taxes" id="id12">Competitive Equilibrium with Distorting Taxes</a></p></li>
<li><p><a class="reference internal" href="#recursive-version-of-amss-model" id="id13">Recursive Version of AMSS Model</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id14">Examples</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id11"><span class="section-number">66.1. </span>Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>In <a class="reference internal" href="opt_tax_recur.html"><span class="doc">an earlier lecture</span></a> we described a model of
optimal taxation with state-contingent debt due to
Robert E. Lucas, Jr.,  and Nancy Stokey  <span id="id1">[<a class="reference internal" href="../zreferences.html#id104" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">LS83</a>]</span>.</p>
<p>Aiyagari, Marcet, Sargent, and Seppälä <span id="id2">[<a class="reference internal" href="../zreferences.html#id59" title="S. Rao Aiyagari, Albert Marcet, Thomas J. Sargent, and Juha Seppala. Optimal Taxation without State-Contingent Debt. Journal of Political Economy, 110(6):1220-1254, December 2002.">AMSS02</a>]</span>  (hereafter, AMSS)
studied optimal taxation in a model without state-contingent debt.</p>
<p>In this lecture, we</p>
<ul class="simple">
<li><p>describe assumptions and equilibrium concepts</p></li>
<li><p>solve the model</p></li>
<li><p>implement the model numerically</p></li>
<li><p>conduct some policy experiments</p></li>
<li><p>compare outcomes with those in a corresponding complete-markets model</p></li>
</ul>
<p>We begin with an introduction to the model.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">LinearAlgebra</span><span class="p">,</span><span class="w"> </span><span class="n">Statistics</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="competitive-equilibrium-with-distorting-taxes">
<h2><a class="toc-backref" href="#id12"><span class="section-number">66.2. </span>Competitive Equilibrium with Distorting Taxes</a><a class="headerlink" href="#competitive-equilibrium-with-distorting-taxes" title="Permalink to this headline">¶</a></h2>
<p>Many but not all features of the economy are identical to those of <a class="reference internal" href="opt_tax_recur.html"><span class="doc">the Lucas-Stokey economy</span></a>.</p>
<p>Let’s start with things that are identical.</p>
<p>For <span class="math notranslate nohighlight">\(t \geq 0\)</span>, a history of the state is represented by <span class="math notranslate nohighlight">\(s^t = [s_t, s_{t-1}, \ldots, s_0]\)</span>.</p>
<p>Government purchases <span class="math notranslate nohighlight">\(g(s)\)</span> are an exact time-invariant function of <span class="math notranslate nohighlight">\(s\)</span>.</p>
<p>Let <span class="math notranslate nohighlight">\(c_t(s^t)\)</span>,  <span class="math notranslate nohighlight">\(\ell_t(s^t)\)</span>, and <span class="math notranslate nohighlight">\(n_t(s^t)\)</span> denote consumption,
leisure, and labor supply, respectively, at history <span class="math notranslate nohighlight">\(s^t\)</span> at time <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>Each period a representative  household is endowed with one unit of time that can be divided between  leisure
<span class="math notranslate nohighlight">\(\ell_t\)</span> and labor <span class="math notranslate nohighlight">\(n_t\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-feas1-amss">
<span class="eqno">(66.1)<a class="headerlink" href="#equation-feas1-amss" title="Permalink to this equation">¶</a></span>\[n_t(s^t) + \ell_t(s^t) = 1\]</div>
<p>Output equals <span class="math notranslate nohighlight">\(n_t(s^t)\)</span> and can be divided between consumption <span class="math notranslate nohighlight">\(c_t(s^t)\)</span> and <span class="math notranslate nohighlight">\(g(s_t)\)</span></p>
<div class="math notranslate nohighlight" id="equation-tss-techr-amss">
<span class="eqno">(66.2)<a class="headerlink" href="#equation-tss-techr-amss" title="Permalink to this equation">¶</a></span>\[c_t(s^t) + g(s_t) = n_t(s^t)\]</div>
<p>Output is not storable.</p>
<p>The technology pins down a pre-tax wage rate to unity for all <span class="math notranslate nohighlight">\(t, s^t\)</span>.</p>
<p>A representative  household’s preferences over <span class="math notranslate nohighlight">\(\{c_t(s^t), \ell_t(s^t)\}_{t=0}^\infty\)</span> are ordered by</p>
<div class="math notranslate nohighlight" id="equation-ts-prefr-amss">
<span class="eqno">(66.3)<a class="headerlink" href="#equation-ts-prefr-amss" title="Permalink to this equation">¶</a></span>\[\sum_{t=0}^\infty \sum_{s^t} \beta^t \pi_t(s^t) u[c_t(s^t), \ell_t(s^t)]\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\pi_t(s^t)\)</span> is a joint probability distribution over the sequence <span class="math notranslate nohighlight">\(s^t\)</span>, and</p></li>
<li><p>the utility function <span class="math notranslate nohighlight">\(u\)</span> is  increasing, strictly concave, and three times  continuously differentiable in both arguments</p></li>
</ul>
<p>The government imposes a flat rate tax <span class="math notranslate nohighlight">\(\tau_t(s^t)\)</span> on labor income at time <span class="math notranslate nohighlight">\(t\)</span>, history <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>Lucas and Stokey assumed that there are complete markets in one-period Arrow securities; also see <a class="reference internal" href="../dynamic_programming/smoothing.html"><span class="doc">smoothing models</span></a>.</p>
<p>It is at this point that AMSS <span id="id3">[<a class="reference internal" href="../zreferences.html#id59" title="S. Rao Aiyagari, Albert Marcet, Thomas J. Sargent, and Juha Seppala. Optimal Taxation without State-Contingent Debt. Journal of Political Economy, 110(6):1220-1254, December 2002.">AMSS02</a>]</span> modify the Lucas and Stokey economy.</p>
<p>AMSS allow the government to issue only one-period risk-free debt each period.</p>
<p>Ruling out complete markets in this way is a step in the direction of making total tax collections behave more like that prescribed in <span id="id4">[<a class="reference internal" href="../zreferences.html#id65" title="Robert J Barro. On the Determination of the Public Debt. Journal of Political Economy, 87(5):940–971, 1979.">Bar79</a>]</span> than they do in <span id="id5">[<a class="reference internal" href="../zreferences.html#id104" title="Robert E Lucas, Jr. and Nancy L Stokey. Optimal Fiscal and Monetary Policy in an Economy without Capital. Journal of monetary Economics, 12(3):55–93, 1983.">LS83</a>]</span>.</p>
<div class="section" id="risk-free-one-period-debt-only">
<h3><span class="section-number">66.2.1. </span>Risk-free One-Period Debt Only<a class="headerlink" href="#risk-free-one-period-debt-only" title="Permalink to this headline">¶</a></h3>
<p>In period <span class="math notranslate nohighlight">\(t\)</span> and history <span class="math notranslate nohighlight">\(s^t\)</span>, let</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> be the amount of the time <span class="math notranslate nohighlight">\(t+1\)</span> consumption good that at time <span class="math notranslate nohighlight">\(t\)</span> the government promised to pay.</p></li>
<li><p><span class="math notranslate nohighlight">\(R_t(s^t)\)</span> be the gross interest rate on  risk-free one-period debt between periods <span class="math notranslate nohighlight">\(t\)</span> and <span class="math notranslate nohighlight">\(t+1\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(T_t(s^t)\)</span> be a nonnegative lump-sum transfer to the representative household <a class="footnote-reference brackets" href="#fn-a" id="id6">1</a>.</p></li>
</ul>
<p>That <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> is the same for all realizations of <span class="math notranslate nohighlight">\(s_{t+1}\)</span> captures its <em>risk-free</em> character.</p>
<p>The market value at time <span class="math notranslate nohighlight">\(t\)</span> of government debt maturing at time <span class="math notranslate nohighlight">\(t+1\)</span> equals <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> divided by <span class="math notranslate nohighlight">\(R_t(s^t)\)</span>.</p>
<p>The government’s budget constraint in period <span class="math notranslate nohighlight">\(t\)</span> at history <span class="math notranslate nohighlight">\(s^t\)</span> is</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo">
<span class="eqno">(66.4)<a class="headerlink" href="#equation-ts-gov-wo" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
b_t(s^{t-1})
    &amp; =    \tau^n_t(s^t) n_t(s^t) - g_t(s_t) - T_t(s^t) +
            {b_{t+1}(s^t) \over R_t(s^t )}
    \\
    &amp; \equiv z(s^t) + {b_{t+1}(s^t) \over R_t(s^t )},
\end{aligned}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(z(s^t)\)</span> is the net-of-interest government surplus.</p>
<p>To rule out Ponzi schemes, we assume that the government is subject to a <strong>natural debt limit</strong> (to be discussed in a forthcoming lecture).</p>
<p>The consumption Euler equation for a representative household able to trade only one-period risk-free debt
with one-period gross interest rate <span class="math notranslate nohighlight">\(R_t(s^t)\)</span> is</p>
<div class="math notranslate nohighlight">
\[
{1 \over R_t(s^t)}
= \sum_{s^{t+1}\vert s^t} \beta  \pi_{t+1}(s^{t+1} | s^t)
                        { u_c(s^{t+1}) \over u_c(s^{t}) }
\]</div>
<p>Substituting this expression into the government’s budget constraint <a class="reference internal" href="#equation-ts-gov-wo">(66.4)</a>
yields:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo2">
<span class="eqno">(66.5)<a class="headerlink" href="#equation-ts-gov-wo2" title="Permalink to this equation">¶</a></span>\[b_t(s^{t-1}) =  z(s^t) + \beta  \sum_{s^{t+1}\vert s^t}  \pi_{t+1}(s^{t+1} | s^t)
                       { u_c(s^{t+1}) \over u_c(s^{t}) } \; b_{t+1}(s^t)\]</div>
<p>Components of <span class="math notranslate nohighlight">\(z(s^t)\)</span> on the right side depend on <span class="math notranslate nohighlight">\(s^t\)</span>, but the left side is required to depend on <span class="math notranslate nohighlight">\(s^{t-1}\)</span> only.</p>
<p><strong>This is what it means for one-period government debt to be risk-free</strong>.</p>
<p>Therefore, the sum on the right side of equation <a class="reference internal" href="#equation-ts-gov-wo2">(66.5)</a> also has to depend only on <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>This requirement will give rise to <strong>measurability constraints</strong> on the Ramsey allocation to be discussed soon.</p>
<p>If we replace <span class="math notranslate nohighlight">\(b_{t+1}(s^t)\)</span> on the right side of equation <a class="reference internal" href="#equation-ts-gov-wo2">(66.5)</a> by the right
side of next period’s budget constraint (associated with a
particular realization <span class="math notranslate nohighlight">\(s_{t}\)</span>) we get</p>
<div class="math notranslate nohighlight">
\[
b_t(s^{t-1}) =  z(s^t) + \sum_{s^{t+1}\vert s^t} \beta  \pi_{t+1}(s^{t+1} | s^t)
                       { u_c(s^{t+1}) \over u_c(s^{t}) }
\, \left[z(s^{t+1}) + {b_{t+2}(s^{t+1}) \over R_{t+1}(s^{t+1})}\right]
\]</div>
<p>After making similar repeated substitutions for all future occurrences of
government indebtedness, and by invoking the natural debt limit, we
arrive at:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo3">
<span class="eqno">(66.6)<a class="headerlink" href="#equation-ts-gov-wo3" title="Permalink to this equation">¶</a></span>\[\begin{aligned}
b_t(s^{t-1})
    &amp;=  \sum_{j=0}^\infty \sum_{s^{t+j} | s^t} \beta^j  \pi_{t+j}(s^{t+j} | s^t)
              { u_c(s^{t+j}) \over u_c(s^{t}) } \;z(s^{t+j})
        \end{aligned}\]</div>
<p>Now let’s</p>
<ul class="simple">
<li><p>substitute the resource constraint into the net-of-interest government surplus, and</p></li>
<li><p>use the household’s first-order condition <span class="math notranslate nohighlight">\(1-\tau^n_t(s^t)= u_{\ell}(s^t) /u_c(s^t)\)</span> to eliminate the labor tax rate</p></li>
</ul>
<p>so that we can express the net-of-interest government surplus <span class="math notranslate nohighlight">\(z(s^t)\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-amss-44-2">
<span class="eqno">(66.7)<a class="headerlink" href="#equation-amss-44-2" title="Permalink to this equation">¶</a></span>\[z(s^t)
    = \left[1 - {u_{\ell}(s^t) \over u_c(s^t)}\right] \left[c_t(s^t)+g_t(s_t)\right]
        -g_t(s_t) - T_t(s^t)\,.\]</div>
<p>If we substitute the  appropriate versions of right side of <a class="reference internal" href="#equation-amss-44-2">(66.7)</a> for <span class="math notranslate nohighlight">\(z(s^{t+j})\)</span> into equation <a class="reference internal" href="#equation-ts-gov-wo3">(66.6)</a>,
we obtain a sequence of <em>implementability constraints</em> on a Ramsey allocation in an AMSS economy.</p>
<p>Expression <a class="reference internal" href="#equation-ts-gov-wo3">(66.6)</a> at time <span class="math notranslate nohighlight">\(t=0\)</span> and initial state <span class="math notranslate nohighlight">\(s^0\)</span>
was also  an <em>implementability constraint</em> on a Ramsey allocation in a Lucas-Stokey economy:</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo4">
<span class="eqno">(66.8)<a class="headerlink" href="#equation-ts-gov-wo4" title="Permalink to this equation">¶</a></span>\[b_0(s^{-1}) = \mathbb{E}\,_0 \sum_{j=0}^\infty \beta^j
               { u_c(s^{j}) \over u_c(s^{0}) } \;z(s^{j})\]</div>
<p>Indeed, it was the <em>only</em> implementability constraint there.</p>
<p>But now we also have a large number of additional implementability constraints</p>
<div class="math notranslate nohighlight" id="equation-ts-gov-wo4a">
<span class="eqno">(66.9)<a class="headerlink" href="#equation-ts-gov-wo4a" title="Permalink to this equation">¶</a></span>\[b_t(s^{t-1}) =  \mathbb{E}\,_t \sum_{j=0}^\infty \beta^j
              { u_c(s^{t+j}) \over u_c(s^{t}) } \;z(s^{t+j})\]</div>
<p>Equation <a class="reference internal" href="#equation-ts-gov-wo4a">(66.9)</a> must hold for each <span class="math notranslate nohighlight">\(s^t\)</span> for each <span class="math notranslate nohighlight">\(t \geq 1\)</span>.</p>
</div>
<div class="section" id="comparison-with-lucas-stokey-economy">
<h3><span class="section-number">66.2.2. </span>Comparison with Lucas-Stokey Economy<a class="headerlink" href="#comparison-with-lucas-stokey-economy" title="Permalink to this headline">¶</a></h3>
<p>The expression on the right side of <a class="reference internal" href="#equation-ts-gov-wo4a">(66.9)</a> in the Lucas-Stokey (1983) economy would  equal the present value of a continuation stream of government surpluses evaluated at what would be competitive equilibrium Arrow-Debreu prices at date <span class="math notranslate nohighlight">\(t\)</span>.</p>
<p>In the Lucas-Stokey economy, that present value is measurable with respect to <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>In the AMSS economy, the restriction that government debt be risk-free imposes that that same present value must be measurable with respect to <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>In a language used in the literature on incomplete markets models, it can be said that the AMSS model requires that at each <span class="math notranslate nohighlight">\((t, s^t)\)</span> what would be the present value of continuation government surpluses in the Lucas-Stokey model must belong to  the <strong>marketable subspace</strong> of the AMSS model.</p>
</div>
<div class="section" id="ramsey-problem-without-state-contingent-debt">
<h3><span class="section-number">66.2.3. </span>Ramsey Problem Without State-contingent Debt<a class="headerlink" href="#ramsey-problem-without-state-contingent-debt" title="Permalink to this headline">¶</a></h3>
<p>After we have substituted the resource constraint into the utility function, we can express the Ramsey problem as being to choose an allocation that solves</p>
<div class="math notranslate nohighlight">
\[
\max_{\{c_t(s^t),b_{t+1}(s^t)\}}
\mathbb{E}\,_0 \sum_{t=0}^\infty \beta^t
                        u\left(c_t(s^t),1-c_t(s^t)-g_t(s_t)\right)
\]</div>
<p>where the maximization is subject to</p>
<div class="math notranslate nohighlight" id="equation-amss-44">
<span class="eqno">(66.10)<a class="headerlink" href="#equation-amss-44" title="Permalink to this equation">¶</a></span>\[\mathbb{E}\,_{0} \sum_{j=0}^\infty \beta^j
      { u_c(s^{j}) \over u_c(s^{0}) } \;z(s^{j}) \geq b_0(s^{-1})\]</div>
<p>and</p>
<div class="math notranslate nohighlight" id="equation-amss-46">
<span class="eqno">(66.11)<a class="headerlink" href="#equation-amss-46" title="Permalink to this equation">¶</a></span>\[\mathbb{E}\,_{t} \sum_{j=0}^\infty \beta^j
    { u_c(s^{t+j}) \over u_c(s^{t}) } \;
    z(s^{t+j}) = b_t(s^{t-1})
      \quad \forall \,  s^t\]</div>
<p>given <span class="math notranslate nohighlight">\(b_0(s^{-1})\)</span>.</p>
<div class="section" id="lagrangian-formulation">
<h4><span class="section-number">66.2.3.1. </span>Lagrangian Formulation<a class="headerlink" href="#lagrangian-formulation" title="Permalink to this headline">¶</a></h4>
<p>Let <span class="math notranslate nohighlight">\(\gamma_0(s^0)\)</span> be a nonnegative Lagrange multiplier on constraint <a class="reference internal" href="#equation-amss-44">(66.10)</a>.</p>
<p>As in the Lucas-Stokey economy, this multiplier is strictly positive when the government must resort to
distortionary taxation; otherwise it equals zero.</p>
<p>A consequence of the assumption that there are no markets in state-contingent securities  and that a market exists only in a risk-free security is that we have to attach stochastic processes <span class="math notranslate nohighlight">\(\{\gamma_t(s^t)\}_{t=1}^\infty\)</span> of
Lagrange multipliers to the implementability constraints <a class="reference internal" href="#equation-amss-46">(66.11)</a>.</p>
<p>Depending on how the constraints  bind, these multipliers can be positive or negative:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{aligned}
   \gamma_t(s^t)
   &amp;\;\geq\; (\leq)\;\, 0 \quad \text{if the constraint binds in this direction }
   \\
   &amp; \mathbb{E}\,_{t} \sum_{j=0}^\infty \beta^j
    { u_c(s^{t+j}) \over u_c(s^{t}) } \;z(s^{t+j}) \;\geq \;(\leq)\;\, b_t(s^{t-1}).
\end{aligned}
\end{split}\]</div>
<p>A negative multiplier <span class="math notranslate nohighlight">\(\gamma_t(s^t)&lt;0\)</span> means that if we could
relax constraint <a class="reference internal" href="#equation-amss-46">(66.11)</a>, we would like to <em>increase</em> the beginning-of-period
indebtedness for that particular realization of history <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>That would let us reduce the beginning-of-period indebtedness for some other history <a class="footnote-reference brackets" href="#fn-b" id="id7">2</a>.</p>
<p>These features flow from  the fact that the government cannot use state-contingent debt and therefore cannot allocate its indebtedness  efficiently across future states.</p>
</div>
</div>
<div class="section" id="some-calculations">
<h3><span class="section-number">66.2.4. </span>Some Calculations<a class="headerlink" href="#some-calculations" title="Permalink to this headline">¶</a></h3>
<p>It is helpful to apply two transformations to the Lagrangian.</p>
<p>Multiply constraint <a class="reference internal" href="#equation-amss-44">(66.10)</a> by <span class="math notranslate nohighlight">\(u_c(s^0)\)</span> and the constraints <a class="reference internal" href="#equation-amss-46">(66.11)</a> by <span class="math notranslate nohighlight">\(\beta^t u_c(s^{t})\)</span>.</p>
<p>Then a Lagrangian for the Ramsey problem can  be represented as</p>
<div class="math notranslate nohighlight" id="equation-amss-lagr-a">
<span class="eqno">(66.12)<a class="headerlink" href="#equation-amss-lagr-a" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
   J &amp;= \mathbb{E}\,_{0} \sum_{t=0}^\infty \beta^t
                        \biggl\{ u\left(c_t(s^t), 1-c_t(s^t)-g_t(s_t)\right)\\
   &amp;  \qquad + \gamma_t(s^t) \Bigl[ \mathbb{E}\,_{t} \sum_{j=0}^\infty \beta^j
         u_c(s^{t+j}) \,z(s^{t+j}) - u_c(s^{t}) \,b_t(s^{t-1}) \biggr\}
         \\
   &amp;= \mathbb{E}\,_{0} \sum_{t=0}^\infty \beta^t
                         \biggl\{ u\left(c_t(s^t), 1-c_t(s^t)-g_t(s_t)\right)
        \\
   &amp;  \qquad + \Psi_t(s^t)\, u_c(s^{t}) \,z(s^{t}) -
   \gamma_t(s^t)\, u_c(s^{t}) \, b_t(s^{t-1})  \biggr\}
\end{aligned}\end{split}\]</div>
<p>where</p>
<div class="math notranslate nohighlight" id="equation-amss-lagr">
<span class="eqno">(66.13)<a class="headerlink" href="#equation-amss-lagr" title="Permalink to this equation">¶</a></span>\[\Psi_t(s^t)=\Psi_{t-1}(s^{t-1})+\gamma_t(s^t)
 \quad \text{and} \quad
\Psi_{-1}(s^{-1})=0\]</div>
<p>In <a class="reference internal" href="#equation-amss-lagr-a">(66.12)</a>,  the second equality uses  the law of iterated expectations
and Abel’s summation formula (also called <em>summation by parts</em>, see
<a class="reference external" href="https://en.wikipedia.org/wiki/Abel%27s_summation_formula">this page</a>).</p>
<p>First-order conditions with respect
to <span class="math notranslate nohighlight">\(c_t(s^t)\)</span> can be expressed as</p>
<div class="math notranslate nohighlight" id="equation-amss-foc-a">
<span class="eqno">(66.14)<a class="headerlink" href="#equation-amss-foc-a" title="Permalink to this equation">¶</a></span>\[\begin{split}\begin{aligned}
  u_c(s^t)-u_{\ell}(s^t) &amp;+ \Psi_t(s^t)\left\{ \left[
    u_{cc}(s^t) - u_{c\ell}(s^{t})\right]z(s^{t}) +
    u_{c}(s^{t})\,z_c(s^{t}) \right\}
    \\
    &amp; \hspace{35mm} - \gamma_t(s^t)\left[
    u_{cc}(s^{t}) - u_{c\ell}(s^{t})\right]b_t(s^{t-1}) =0
\end{aligned}\end{split}\]</div>
<p>and with respect to <span class="math notranslate nohighlight">\(b_t(s^t)\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-amss-foc-b">
<span class="eqno">(66.15)<a class="headerlink" href="#equation-amss-foc-b" title="Permalink to this equation">¶</a></span>\[\mathbb{E}\,_{t} \left[\gamma_{t+1}(s^{t+1})\,u_c(s^{t+1})\right] = 0\]</div>
<p>If we substitute <span class="math notranslate nohighlight">\(z(s^t)\)</span> from <a class="reference internal" href="#equation-amss-44-2">(66.7)</a> and its derivative
<span class="math notranslate nohighlight">\(z_c(s^t)\)</span> into first-order condition <a class="reference internal" href="#equation-amss-foc-a">(66.14)</a>, we  find  two
differences from the corresponding condition for the optimal allocation
in a Lucas-Stokey economy with state-contingent government debt.</p>
<ol class="simple">
<li><p>The term involving <span class="math notranslate nohighlight">\(b_t(s^{t-1})\)</span> in first-order condition
<a class="reference internal" href="#equation-amss-foc-a">(66.14)</a> does not appear in the corresponding expression
for the Lucas-Stokey economy.</p></li>
</ol>
<ul class="simple">
<li><p>This term reflects the constraint that
beginning-of-period government indebtedness must be the same across all
realizations of next period’s state, a constraint that would  not be present if
government debt could be state contingent.</p></li>
</ul>
<ol class="simple">
<li><p>The Lagrange multiplier <span class="math notranslate nohighlight">\(\Psi_t(s^t)\)</span> in first-order condition
<a class="reference internal" href="#equation-amss-foc-a">(66.14)</a> may change over time in response to realizations of the state,
while the multiplier <span class="math notranslate nohighlight">\(\Phi\)</span> in the Lucas-Stokey economy is time invariant.</p></li>
</ol>
<p>We need some code from our <a class="reference internal" href="opt_tax_recur.html"><span class="doc">an earlier lecture</span></a>
on optimal taxation with state-contingent debt  sequential allocation implementation:</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">QuantEcon</span><span class="p">,</span><span class="w"> </span><span class="n">NLsolve</span><span class="p">,</span><span class="w"> </span><span class="n">NLopt</span>

<span class="k">import</span><span class="w"> </span><span class="n">QuantEcon</span><span class="o">.</span><span class="n">simulate</span>

<span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">Model</span><span class="p">{</span><span class="kt">TF</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractFloat</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">TM</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractMatrix</span><span class="p">{</span><span class="kt">TF</span><span class="p">},</span>
<span class="w">                    </span><span class="kt">TV</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">TF</span><span class="p">}}</span>
<span class="w">    </span><span class="n">β</span><span class="o">::</span><span class="kt">TF</span>
<span class="w">    </span><span class="n">Π</span><span class="o">::</span><span class="kt">TM</span>
<span class="w">    </span><span class="n">G</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">Θ</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">transfers</span><span class="o">::</span><span class="kt">Bool</span>
<span class="w">    </span><span class="n">U</span><span class="o">::</span><span class="kt">Function</span>
<span class="w">    </span><span class="n">Uc</span><span class="o">::</span><span class="kt">Function</span>
<span class="w">    </span><span class="n">Ucc</span><span class="o">::</span><span class="kt">Function</span>
<span class="w">    </span><span class="n">Un</span><span class="o">::</span><span class="kt">Function</span>
<span class="w">    </span><span class="n">Unn</span><span class="o">::</span><span class="kt">Function</span>
<span class="w">    </span><span class="n">n_less_than_one</span><span class="o">::</span><span class="kt">Bool</span>
<span class="k">end</span>


<span class="k">struct</span> <span class="kt">SequentialAllocation</span><span class="p">{</span><span class="kt">TP</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">TI</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">TV</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">}</span>
<span class="w">    </span><span class="n">model</span><span class="o">::</span><span class="kt">TP</span>
<span class="w">    </span><span class="n">mc</span><span class="o">::</span><span class="kt">MarkovChain</span>
<span class="w">    </span><span class="n">S</span><span class="o">::</span><span class="kt">TI</span>
<span class="w">    </span><span class="n">cFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">nFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">ΞFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">zFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">)</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span>
<span class="w">    </span><span class="n">mc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MarkovChain</span><span class="p">(</span><span class="n">Π</span><span class="p">)</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c"># Number of states</span>
<span class="w">    </span><span class="c"># Now find the first best allocation</span>
<span class="w">    </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">ΞFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_first_best</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">ΞFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">find_first_best</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">throw</span><span class="p">(</span><span class="kt">ArgumentError</span><span class="p">(</span><span class="s">&quot;version must be 1 or 2&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">res!</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Un</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">G</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlsolve</span><span class="p">(</span><span class="n">res!</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">S</span><span class="p">))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">converged</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span>
<span class="w">        </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not find first best&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span>
<span class="w">        </span><span class="n">cFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">zero</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="n">nFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">zero</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">ΞFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">)</span><span class="w">         </span><span class="c"># Multiplier on the resource constraint</span>
<span class="w">        </span><span class="n">zFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">ΞFB</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">ΞFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span>
<span class="w">    </span><span class="k">elseif</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span>
<span class="w">        </span><span class="n">cFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">zero</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="n">nFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">zero</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">IFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">cFB</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">nFB</span>
<span class="w">        </span><span class="n">xFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">\</span><span class="p">(</span><span class="n">LinearAlgebra</span><span class="o">.</span><span class="n">I</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">IFB</span><span class="p">)</span>
<span class="w">        </span><span class="n">zFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vcat</span><span class="p">(</span><span class="n">cFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">xFB</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">xFB</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">IFB</span><span class="p">,</span><span class="w"> </span><span class="n">xFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">pas</span><span class="o">::</span><span class="kt">SequentialAllocation</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="o">::</span><span class="kt">Real</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">Unn</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Unn</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">FOC!</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="o">::</span><span class="kt">Vector</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="n">Ξ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">μ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Ucc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="c"># FOC c</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Un</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">μ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Un</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="c"># FOC n</span>
<span class="w">        </span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="c"># resource constraint</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">out</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Find the root of the FOC</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlsolve</span><span class="p">(</span><span class="n">FOC!</span><span class="p">,</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">zFB</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">f_converged</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span>
<span class="w">        </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not find LS allocation.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">zero</span>
<span class="w">    </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="n">S</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">    </span><span class="c"># Now compute x</span>
<span class="w">    </span><span class="n">I</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">\</span><span class="p">(</span><span class="n">LinearAlgebra</span><span class="o">.</span><span class="n">I</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Ξ</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">pas</span><span class="o">::</span><span class="kt">SequentialAllocation</span><span class="p">,</span>
<span class="w">                        </span><span class="n">B_</span><span class="o">::</span><span class="kt">AbstractFloat</span><span class="p">,</span><span class="w"> </span><span class="n">s_0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">model</span>
<span class="w">    </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span>
<span class="w">    </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">Unn</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Unn</span>

<span class="w">    </span><span class="c"># First order conditions of planner&#39;s problem</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">FOC!</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">)</span>
<span class="w">        </span><span class="n">μ</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="w">        </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">pas</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="p">)[</span><span class="mi">3</span><span class="p">]</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span>
<span class="w">        </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B_</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_0</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xprime</span><span class="p">),</span>
<span class="w">        </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">μ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B_</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">Ξ</span><span class="p">,</span>
<span class="w">        </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">μ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">s_0</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">Ξ</span><span class="p">,</span>
<span class="w">        </span><span class="p">(</span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">G</span><span class="p">)[</span><span class="n">s_0</span><span class="p">]</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="c"># Find root</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nlsolve</span><span class="p">(</span><span class="n">FOC!</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">cFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">nFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">],</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">ΞFB</span><span class="p">[</span><span class="n">s_0</span><span class="p">]])</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">res</span><span class="o">.</span><span class="n">f_converged</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">false</span>
<span class="w">        </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Could not find time 0 LS allocation.&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">zero</span><span class="o">...</span><span class="p">,)</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">time1_value</span><span class="p">(</span><span class="n">pas</span><span class="o">::</span><span class="kt">SequentialAllocation</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="o">::</span><span class="kt">Real</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">model</span>
<span class="w">    </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">pas</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="p">)</span>
<span class="w">    </span><span class="n">U_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">\</span><span class="p">(</span><span class="n">LinearAlgebra</span><span class="o">.</span><span class="n">I</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="o">*</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">U_val</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">V</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">Τ</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">::</span><span class="kt">Union</span><span class="p">{</span><span class="kt">Real</span><span class="p">,</span><span class="kt">Vector</span><span class="p">},</span><span class="w"> </span><span class="n">n</span><span class="o">::</span><span class="kt">Union</span><span class="p">{</span><span class="kt">Real</span><span class="p">,</span><span class="kt">Vector</span><span class="p">})</span>
<span class="w">    </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Un</span><span class="o">./</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">Uc</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">pas</span><span class="o">::</span><span class="kt">SequentialAllocation</span><span class="p">,</span>
<span class="w">                </span><span class="n">B_</span><span class="o">::</span><span class="kt">AbstractFloat</span><span class="p">,</span><span class="w"> </span><span class="n">s_0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                </span><span class="n">T</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                </span><span class="n">sHist</span><span class="o">::</span><span class="kt">Union</span><span class="p">{</span><span class="kt">Vector</span><span class="p">,</span><span class="w"> </span><span class="kt">Nothing</span><span class="p">}</span><span class="o">=</span><span class="nb">nothing</span><span class="p">)</span>

<span class="w">    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pas</span><span class="o">.</span><span class="n">model</span>
<span class="w">    </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">isnothing</span><span class="p">(</span><span class="n">sHist</span><span class="p">)</span>
<span class="w">        </span><span class="n">sHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QuantEcon</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="n">pas</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="o">=</span><span class="n">s_0</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">cHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">nHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">Bhist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">ΤHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">μHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">RHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="c"># time 0</span>
<span class="w">    </span><span class="n">μ</span><span class="p">,</span><span class="w"> </span><span class="n">cHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">_</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">pas</span><span class="p">,</span><span class="w"> </span><span class="n">B_</span><span class="p">,</span><span class="w"> </span><span class="n">s_0</span><span class="p">)</span>
<span class="w">    </span><span class="n">ΤHist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Τ</span><span class="p">(</span><span class="n">pas</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">cHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
<span class="w">    </span><span class="n">Bhist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B_</span>
<span class="w">    </span><span class="n">μHist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">μ</span>
<span class="w">    </span><span class="c"># time 1 onward</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="n">T</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">Ξ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time1_allocation</span><span class="p">(</span><span class="n">pas</span><span class="p">,</span><span class="n">μ</span><span class="p">)</span>
<span class="w">        </span><span class="n">u_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
<span class="w">        </span><span class="n">ΤHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Τ</span><span class="p">(</span><span class="n">pas</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)[</span><span class="n">s</span><span class="p">]</span>
<span class="w">        </span><span class="n">Eu_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">u_c</span><span class="p">)</span>
<span class="w">        </span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">u_c</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
<span class="w">        </span><span class="n">RHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Eu_c</span><span class="p">)</span>
<span class="w">        </span><span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">μ</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cHist</span><span class="p">,</span><span class="w"> </span><span class="n">nHist</span><span class="p">,</span><span class="w"> </span><span class="n">Bhist</span><span class="p">,</span><span class="w"> </span><span class="n">ΤHist</span><span class="p">,</span><span class="w"> </span><span class="n">sHist</span><span class="p">,</span><span class="w"> </span><span class="n">μHist</span><span class="p">,</span><span class="w"> </span><span class="n">RHist</span>
<span class="k">end</span>


<span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">BellmanEquation</span><span class="p">{</span><span class="kt">TP</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">TI</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">TV</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">,</span>
<span class="w">                            </span><span class="kt">TM</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractMatrix</span><span class="p">{</span><span class="kt">TV</span><span class="p">},</span>
<span class="w">                            </span><span class="kt">TVV</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">TV</span><span class="p">}}</span>
<span class="w">    </span><span class="n">model</span><span class="o">::</span><span class="kt">TP</span>
<span class="w">    </span><span class="n">S</span><span class="o">::</span><span class="kt">TI</span>
<span class="w">    </span><span class="n">xbar</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">time_0</span><span class="o">::</span><span class="kt">Bool</span>
<span class="w">    </span><span class="n">z0</span><span class="o">::</span><span class="kt">TM</span>
<span class="w">    </span><span class="n">cFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">nFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">xFB</span><span class="o">::</span><span class="kt">TV</span>
<span class="w">    </span><span class="n">zFB</span><span class="o">::</span><span class="kt">TVV</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">BellmanEquation</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">,</span><span class="w"> </span><span class="n">policies0</span><span class="o">::</span><span class="kt">Vector</span><span class="p">)</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c"># number of states</span>
<span class="w">    </span><span class="n">xbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">minimum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">),</span><span class="w"> </span><span class="n">maximum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)]</span>
<span class="w">    </span><span class="n">time_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">    </span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">nf</span><span class="p">,</span><span class="w"> </span><span class="n">xprimef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">policies0</span>
<span class="w">    </span><span class="n">z0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">vcat</span><span class="p">(</span><span class="n">cf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">nf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="p">[</span><span class="n">xprimef</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">](</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">])</span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">xgrid</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">    </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">IFB</span><span class="p">,</span><span class="w"> </span><span class="n">xFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_first_best</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BellmanEquation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">,</span><span class="w"> </span><span class="n">time_0</span><span class="p">,</span><span class="w"> </span><span class="n">z0</span><span class="p">,</span><span class="w"> </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">xFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">get_policies_time1</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation</span><span class="p">,</span>
<span class="w">                        </span><span class="n">i_x</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="o">::</span><span class="kt">AbstractFloat</span><span class="p">,</span>
<span class="w">                        </span><span class="n">s</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span>
<span class="w">    </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">objf</span><span class="p">(</span><span class="n">z</span><span class="o">::</span><span class="kt">Vector</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
<span class="w">        </span><span class="n">Vprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Vf</span><span class="p">[</span><span class="n">sprime</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">sprime</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">Vprime</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">cons</span><span class="p">(</span><span class="n">z</span><span class="o">::</span><span class="kt">Vector</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="o">=</span><span class="n">c</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xprime</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="w">    </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="w">    </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">min_objective!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">objf</span><span class="p">)</span>
<span class="w">    </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">)</span>
<span class="w">    </span><span class="n">lower_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">lb</span><span class="p">)</span>
<span class="w">    </span><span class="n">upper_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">ub</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxeval!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxtime!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">][</span><span class="mi">3</span><span class="o">:</span><span class="k">end</span><span class="p">])</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">            </span><span class="n">init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">            </span><span class="n">init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="p">(</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLopt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="p">)</span>
<span class="w">    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">])</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="o">-</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">])</span>
<span class="k">end</span>

<span class="k">function</span><span class="w"> </span><span class="n">get_policies_time0</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation</span><span class="p">,</span>
<span class="w">                        </span><span class="n">B_</span><span class="o">::</span><span class="kt">AbstractFloat</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="o">::</span><span class="kt">Array</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span>
<span class="w">    </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">objf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>
<span class="w">        </span><span class="n">Vprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Vf</span><span class="p">[</span><span class="n">sprime</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">sprime</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">Vprime</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">cons</span><span class="p">(</span><span class="n">z</span><span class="o">::</span><span class="kt">Vector</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B_</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xprime</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="w">    </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="w">    </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="n">min_objective!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">objf</span><span class="p">)</span>
<span class="w">    </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">)</span>
<span class="w">    </span><span class="n">lower_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">lb</span><span class="p">)</span>
<span class="w">    </span><span class="n">upper_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">ub</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxeval!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxtime!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">3</span><span class="o">:</span><span class="k">end</span><span class="p">])</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">init</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">            </span><span class="n">init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="k">elseif</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">            </span><span class="n">init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="p">(</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLopt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="o">-</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">2</span><span class="o">:</span><span class="k">end</span><span class="p">]))</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>get_policies_time0 (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>To analyze the AMSS model, we find it useful to adopt a recursive formulation
using techniques like those in our lectures on <a class="reference internal" href="dyn_stack.html"><span class="doc">dynamic Stackelberg models</span></a> and <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
</div>
</div>
<div class="section" id="recursive-version-of-amss-model">
<h2><a class="toc-backref" href="#id13"><span class="section-number">66.3. </span>Recursive Version of AMSS Model</a><a class="headerlink" href="#recursive-version-of-amss-model" title="Permalink to this headline">¶</a></h2>
<p>We now describe a recursive formulation of the AMSS economy.</p>
<p>We have noted that from the point of view of the Ramsey planner, the restriction
to one-period risk-free securities</p>
<ul class="simple">
<li><p>leaves intact the single implementability constraint on allocations
<a class="reference internal" href="#equation-ts-gov-wo4">(66.8)</a> from the Lucas-Stokey economy, but</p></li>
<li><p>adds measurability constraints <a class="reference internal" href="#equation-ts-gov-wo3">(66.6)</a> on functions of tails of
allocations at each time and history</p></li>
</ul>
<p>We now explore how these constraints alter  Bellman equations for a time
<span class="math notranslate nohighlight">\(0\)</span> Ramsey planner and for time <span class="math notranslate nohighlight">\(t \geq 1\)</span>, history <span class="math notranslate nohighlight">\(s^t\)</span>
continuation Ramsey planners.</p>
<div class="section" id="recasting-state-variables">
<h3><span class="section-number">66.3.1. </span>Recasting State Variables<a class="headerlink" href="#recasting-state-variables" title="Permalink to this headline">¶</a></h3>
<p>In the AMSS setting, the government faces a sequence of budget constraints</p>
<div class="math notranslate nohighlight">
\[
\tau_t(s^t) n_t(s^t) + T_t(s^t) +  b_{t+1}(s^t)/ R_t (s^t) =  g_t + b_t(s^{t-1})
\]</div>
<p>where <span class="math notranslate nohighlight">\(R_t(s^t)\)</span> is the gross risk-free rate of interest between <span class="math notranslate nohighlight">\(t\)</span>
and <span class="math notranslate nohighlight">\(t+1\)</span> at history <span class="math notranslate nohighlight">\(s^t\)</span> and <span class="math notranslate nohighlight">\(T_t(s^t)\)</span> are nonnegative transfers.</p>
<p>Throughout this lecture, we shall set transfers to zero (for some issues about the limiting behavior of debt, this makes a possibly
important difference from AMSS <span id="id8">[<a class="reference internal" href="../zreferences.html#id59" title="S. Rao Aiyagari, Albert Marcet, Thomas J. Sargent, and Juha Seppala. Optimal Taxation without State-Contingent Debt. Journal of Political Economy, 110(6):1220-1254, December 2002.">AMSS02</a>]</span>, who restricted transfers
to be nonnegative).</p>
<p>In this case, the household faces a sequence of budget constraints</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp1">
<span class="eqno">(66.16)<a class="headerlink" href="#equation-eqn-amssapp1" title="Permalink to this equation">¶</a></span>\[b_t(s^{t-1}) + (1-\tau_t(s^t)) n_t(s^t) = c_t(s^t) + b_{t+1}(s^t)/R_t(s^t)\]</div>
<p>The household’s first-order conditions are <span class="math notranslate nohighlight">\(u_{c,t} = \beta R_t \mathbb{E}\,_t u_{c,t+1}\)</span>
and <span class="math notranslate nohighlight">\((1-\tau_t) u_{c,t} = u_{l,t}\)</span>.</p>
<p>Using these to eliminate <span class="math notranslate nohighlight">\(R_t\)</span> and <span class="math notranslate nohighlight">\(\tau_t\)</span> from  budget constraint
<a class="reference internal" href="#equation-eqn-amssapp1">(66.16)</a> gives</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2a">
<span class="eqno">(66.17)<a class="headerlink" href="#equation-eqn-amssapp2a" title="Permalink to this equation">¶</a></span>\[b_t(s^{t-1}) + \frac{u_{l,t}(s^t)}{u_{c,t}(s^t)} n_t(s^t)
= c_t(s^t) + {\frac{\beta (\mathbb{E}\,_t u_{c,t+1}) b_{t+1}(s^t)}{u_{c,t}(s^t)}}\]</div>
<p>or</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2">
<span class="eqno">(66.18)<a class="headerlink" href="#equation-eqn-amssapp2" title="Permalink to this equation">¶</a></span>\[u_{c,t}(s^t) b_t(s^{t-1}) + u_{l,t}(s^t) n_t(s^t)
= u_{c,t}(s^t) c_t(s^t) + \beta (\mathbb{E}\,_t u_{c,t+1}) b_{t+1}(s^t)\]</div>
<p>Now define</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp3">
<span class="eqno">(66.19)<a class="headerlink" href="#equation-eqn-amssapp3" title="Permalink to this equation">¶</a></span>\[x_t \equiv \beta b_{t+1}(s^t) \mathbb{E}\,_t u_{c,t+1} = u_{c,t} (s^t) {\frac{b_{t+1}(s^t)}{R_t(s^t)}}\]</div>
<p>and represent the household’s budget constraint at time <span class="math notranslate nohighlight">\(t\)</span>,
history <span class="math notranslate nohighlight">\(s^t\)</span> as</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp4">
<span class="eqno">(66.20)<a class="headerlink" href="#equation-eqn-amssapp4" title="Permalink to this equation">¶</a></span>\[{\frac{u_{c,t} x_{t-1}}{\beta \mathbb{E}\,_{t-1} u_{c,t}}} = u_{c,t} c_t - u_{l,t} n_t + x_t\]</div>
<p>for <span class="math notranslate nohighlight">\(t \geq 1\)</span>.</p>
</div>
<div class="section" id="measurability-constraints">
<h3><span class="section-number">66.3.2. </span>Measurability Constraints<a class="headerlink" href="#measurability-constraints" title="Permalink to this headline">¶</a></h3>
<p>Write equation <a class="reference internal" href="#equation-eqn-amssapp2">(66.18)</a> as</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp2b">
<span class="eqno">(66.21)<a class="headerlink" href="#equation-eqn-amssapp2b" title="Permalink to this equation">¶</a></span>\[b_t(s^{t-1})  = c_t(s^t) -  { \frac{u_{l,t}(s^t)}{u_{c,t}(s^t)}} n_t(s^t) +
{\frac{\beta (\mathbb{E}\,_t u_{c,t+1}) b_{t+1}(s^t)}{u_{c,t}}}\]</div>
<p>The right side of equation <a class="reference internal" href="#equation-eqn-amssapp2b">(66.21)</a> expresses the time <span class="math notranslate nohighlight">\(t\)</span> value of government debt
in terms of a linear combination of terms whose individual components
are measurable with respect to <span class="math notranslate nohighlight">\(s^t\)</span>.</p>
<p>The sum  of terms on the right side  of equation <a class="reference internal" href="#equation-eqn-amssapp2b">(66.21)</a> must equal
<span class="math notranslate nohighlight">\(b_t(s^{t-1})\)</span>.</p>
<p>That implies that it is has to be <em>measurable</em> with respect to <span class="math notranslate nohighlight">\(s^{t-1}\)</span>.</p>
<p>Equations <a class="reference internal" href="#equation-eqn-amssapp2b">(66.21)</a> are the <em>measurablility constraints</em> that the AMSS model adds to the single time <span class="math notranslate nohighlight">\(0\)</span> implementation
constraint imposed in the Lucas and Stokey model.</p>
</div>
<div class="section" id="two-bellman-equations">
<h3><span class="section-number">66.3.3. </span>Two Bellman Equations<a class="headerlink" href="#two-bellman-equations" title="Permalink to this headline">¶</a></h3>
<p>Let <span class="math notranslate nohighlight">\(\Pi(s|s_-)\)</span> be a Markov transition matrix whose entries tell probabilities of moving from state <span class="math notranslate nohighlight">\(s_-\)</span> to state <span class="math notranslate nohighlight">\(s\)</span> in one period.</p>
<p>Let</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(V(x_-, s_-)\)</span> be the continuation value of a continuation
Ramsey plan at <span class="math notranslate nohighlight">\(x_{t-1} = x_-, s_{t-1} =s_-\)</span> for <span class="math notranslate nohighlight">\(t \geq 1\)</span>.</p></li>
<li><p><span class="math notranslate nohighlight">\(W(b, s)\)</span> be the value of the Ramsey plan at time <span class="math notranslate nohighlight">\(0\)</span> at
<span class="math notranslate nohighlight">\(b_0=b\)</span> and <span class="math notranslate nohighlight">\(s_0 = s\)</span>.</p></li>
</ul>
<p>We distinguish between two types of planners:</p>
<p>For <span class="math notranslate nohighlight">\(t \geq 1\)</span>, the value function for a <strong>continuation Ramsey planner</strong>
satisfies the Bellman equation</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp5">
<span class="eqno">(66.22)<a class="headerlink" href="#equation-eqn-amssapp5" title="Permalink to this equation">¶</a></span>\[V(x_-,s_-) = \max_{\{n(s), x(s)\}} \sum_s \Pi(s|s_-) \left[ u(n(s) -
g(s), 1-n(s)) + \beta V(x(s),s) \right]\]</div>
<p>subject to the following collection of implementability constraints, one
for each <span class="math notranslate nohighlight">\(s \in {\cal S}\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp6">
<span class="eqno">(66.23)<a class="headerlink" href="#equation-eqn-amssapp6" title="Permalink to this equation">¶</a></span>\[{\frac{u_c(s) x_- }{\beta \sum_{\tilde s} \Pi(\tilde s|s_-) u_c(\tilde s) }}
= u_c(s) (n(s) - g(s)) - u_l(s) n(s) + x(s)\]</div>
<p>A continuation Ramsey planner at <span class="math notranslate nohighlight">\(t \geq 1\)</span> takes
<span class="math notranslate nohighlight">\((x_{t-1}, s_{t-1}) = (x_-, s_-)\)</span> as given and before
<span class="math notranslate nohighlight">\(s\)</span> is realized chooses
<span class="math notranslate nohighlight">\((n_t(s_t), x_t(s_t)) = (n(s), x(s))\)</span> for <span class="math notranslate nohighlight">\(s \in  {\cal S}\)</span>.</p>
<p>The <strong>Ramsey planner</strong> takes <span class="math notranslate nohighlight">\((b_0, s_0)\)</span> as given and chooses <span class="math notranslate nohighlight">\((n_0, x_0)\)</span>.</p>
<p>The value function <span class="math notranslate nohighlight">\(W(b_0, s_0)\)</span>   for the time <span class="math notranslate nohighlight">\(t=0\)</span> Ramsey planner
satisfies the Bellman equation</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp100">
<span class="eqno">(66.24)<a class="headerlink" href="#equation-eqn-amssapp100" title="Permalink to this equation">¶</a></span>\[W(b_0, s_0) = \max_{n_0, x_0} u(n_0 - g_0, 1-n_0) + \beta V(x_0,s_0)\]</div>
<p>where maximization is subject to</p>
<div class="math notranslate nohighlight" id="equation-eqn-ammssapp101">
<span class="eqno">(66.25)<a class="headerlink" href="#equation-eqn-ammssapp101" title="Permalink to this equation">¶</a></span>\[u_{c,0} b_0 = u_{c,0} (n_0-g_0) - u_{l,0} n_0 + x_0\]</div>
</div>
<div class="section" id="martingale-supercedes-state-variable-degeneracy">
<h3><span class="section-number">66.3.4. </span>Martingale Supercedes State-Variable Degeneracy<a class="headerlink" href="#martingale-supercedes-state-variable-degeneracy" title="Permalink to this headline">¶</a></h3>
<p>Let <span class="math notranslate nohighlight">\(\mu(s|s_-) \Pi(s|s_-)\)</span> be a Lagrange multiplier on constraint <a class="reference internal" href="#equation-eqn-amssapp6">(66.23)</a>
for state <span class="math notranslate nohighlight">\(s\)</span>.</p>
<p>After forming an appropriate Lagrangian, we find that the continuation Ramsey planner’s first-order
condition with respect to <span class="math notranslate nohighlight">\(x(s)\)</span> is</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp7">
<span class="eqno">(66.26)<a class="headerlink" href="#equation-eqn-amssapp7" title="Permalink to this equation">¶</a></span>\[\beta V_x(x(s),s) = \mu(s|s_-)\]</div>
<p>Applying the envelope theorem to Bellman equation <a class="reference internal" href="#equation-eqn-amssapp5">(66.22)</a> gives</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp8">
<span class="eqno">(66.27)<a class="headerlink" href="#equation-eqn-amssapp8" title="Permalink to this equation">¶</a></span>\[V_x(x_-,s_-) = \sum_s \Pi(s|s_-) \mu(s|s_-) {\frac{u_c(s)}{\beta \sum_{\tilde s}
\Pi(\tilde s|s_-) u_c(\tilde s) }}\]</div>
<p>Equations <a class="reference internal" href="#equation-eqn-amssapp7">(66.26)</a> and <a class="reference internal" href="#equation-eqn-amssapp8">(66.27)</a> imply that</p>
<div class="math notranslate nohighlight" id="equation-eqn-amssapp9">
<span class="eqno">(66.28)<a class="headerlink" href="#equation-eqn-amssapp9" title="Permalink to this equation">¶</a></span>\[V_x(x_-, s_-) = \sum_{s} \left( \Pi(s|s_-) {\frac{u_c(s)}{\sum_{\tilde s}
\Pi(\tilde s| s_-) u_c(\tilde s)}} \right) V_x(x(s), s)\]</div>
<p>Equation <a class="reference internal" href="#equation-eqn-amssapp9">(66.28)</a> states that <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> is a <em>risk-adjusted martingale</em>.</p>
<p>Saying that <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> is a risk-adjusted martingale  means  that
<span class="math notranslate nohighlight">\(V_x(x, s)\)</span>  is a martingale with respect to the probability distribution
over <span class="math notranslate nohighlight">\(s^t\)</span> sequences that is generated by the <em>twisted</em> transition probability matrix:</p>
<div class="math notranslate nohighlight">
\[
\check \Pi(s|s_-) \equiv \Pi(s|s_-) {\frac{u_c(s)}{\sum_{\tilde s}
\Pi(\tilde s| s_-) u_c(\tilde s)}}
\]</div>
<p><strong>Exercise</strong>: Please verify that <span class="math notranslate nohighlight">\(\check \Pi(s|s_-)\)</span> is a valid Markov
transition density, i.e., that its elements are all nonnegative and
that for each <span class="math notranslate nohighlight">\(s_-\)</span>, the sum over <span class="math notranslate nohighlight">\(s\)</span> equals unity.</p>
</div>
<div class="section" id="absence-of-state-variable-degeneracy">
<h3><span class="section-number">66.3.5. </span>Absence of State Variable Degeneracy<a class="headerlink" href="#absence-of-state-variable-degeneracy" title="Permalink to this headline">¶</a></h3>
<p>Along a Ramsey plan, the state variable <span class="math notranslate nohighlight">\(x_t = x_t(s^t, b_0)\)</span>
becomes a function of the history <span class="math notranslate nohighlight">\(s^t\)</span> and initial
government debt <span class="math notranslate nohighlight">\(b_0\)</span>.</p>
<p>In <a class="reference internal" href="opt_tax_recur.html"><span class="doc">Lucas-Stokey model</span></a>, we
found that</p>
<ul class="simple">
<li><p>a counterpart to <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> is time invariant and equal to
the Lagrange multiplier on the Lucas-Stokey implementability constraint</p></li>
<li><p>time invariance of <span class="math notranslate nohighlight">\(V_x(x,s)\)</span>  is the source of a key
feature of the Lucas-Stokey model, namely, state variable degeneracy
(i.e., <span class="math notranslate nohighlight">\(x_t\)</span> is an exact function of <span class="math notranslate nohighlight">\(s_t\)</span>)</p></li>
</ul>
<p>That <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> varies over time according to a twisted martingale
means that there is no state-variable degeneracy in the AMSS model.</p>
<p>In the AMSS model, both <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(s\)</span> are needed to describe the state.</p>
<p>This property of the AMSS model  transmits a twisted martingale
component to consumption, employment, and the tax rate.</p>
</div>
<div class="section" id="digression-on-nonnegative-transfers">
<h3><span class="section-number">66.3.6. </span>Digression on Nonnegative Transfers<a class="headerlink" href="#digression-on-nonnegative-transfers" title="Permalink to this headline">¶</a></h3>
<p>Throughout this lecture we have imposed that transfers <span class="math notranslate nohighlight">\(T_t = 0\)</span>.</p>
<p>AMSS <span id="id9">[<a class="reference internal" href="../zreferences.html#id59" title="S. Rao Aiyagari, Albert Marcet, Thomas J. Sargent, and Juha Seppala. Optimal Taxation without State-Contingent Debt. Journal of Political Economy, 110(6):1220-1254, December 2002.">AMSS02</a>]</span> instead imposed a nonnegativity
constraint <span class="math notranslate nohighlight">\(T_t\geq 0\)</span> on transfers.</p>
<p>They also considered a special case of quasi-linear preferences,
<span class="math notranslate nohighlight">\(u(c,l)= c + H(l)\)</span>.</p>
<p>In this case, <span class="math notranslate nohighlight">\(V_x(x,s)\leq 0\)</span> is a non-positive martingale.</p>
<p>By the <em>martingale convergence theorem</em>  <span class="math notranslate nohighlight">\(V_x(x,s)\)</span> converges almost surely.</p>
<p>Furthermore, when the Markov chain <span class="math notranslate nohighlight">\(\Pi(s| s_-)\)</span> and the government
expenditure function <span class="math notranslate nohighlight">\(g(s)\)</span> are such that <span class="math notranslate nohighlight">\(g_t\)</span> is perpetually
random, <span class="math notranslate nohighlight">\(V_x(x, s)\)</span> almost surely converges to zero.</p>
<p>For quasi-linear preferences, the first-order condition with respect to <span class="math notranslate nohighlight">\(n(s)\)</span> becomes</p>
<div class="math notranslate nohighlight">
\[
(1-\mu(s|s_-) ) (1 - u_l(s)) + \mu(s|s_-) n(s) u_{ll}(s) =0
\]</div>
<p>When <span class="math notranslate nohighlight">\(\mu(s|s_-) = \beta V_x(x(s),x)\)</span> converges to zero, in the limit
<span class="math notranslate nohighlight">\(u_l(s)= 1 =u_c(s)\)</span>, so that <span class="math notranslate nohighlight">\(\tau(x(s),s) =0\)</span>.</p>
<p>Thus, in the limit, if <span class="math notranslate nohighlight">\(g_t\)</span> is perpetually random,  the government
accumulates sufficient assets to finance all expenditures from earnings on those
assets, returning any excess revenues to the household as nonnegative lump sum transfers.</p>
</div>
<div class="section" id="code">
<h3><span class="section-number">66.3.7. </span>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h3>
<p>The recursive formulation is implemented as follows</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">using</span><span class="w"> </span><span class="n">DataInterpolations</span>

<span class="k">mutable</span><span class="w"> </span><span class="k">struct</span> <span class="kt">BellmanEquation_Recursive</span><span class="p">{</span><span class="kt">TP</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="kt">TI</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="kt">TR</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Real</span><span class="p">}</span>
<span class="w">    </span><span class="n">model</span><span class="o">::</span><span class="kt">TP</span>
<span class="w">    </span><span class="n">S</span><span class="o">::</span><span class="kt">TI</span>
<span class="w">    </span><span class="n">xbar</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}</span>
<span class="w">    </span><span class="n">time_0</span><span class="o">::</span><span class="kt">Bool</span>
<span class="w">    </span><span class="n">z0</span><span class="o">::</span><span class="kt">Array</span><span class="p">{</span><span class="kt">Array</span><span class="p">}</span>
<span class="w">    </span><span class="n">cFB</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">TR</span><span class="p">}</span>
<span class="w">    </span><span class="n">nFB</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">TR</span><span class="p">}</span>
<span class="w">    </span><span class="n">xFB</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">TR</span><span class="p">}</span>
<span class="w">    </span><span class="n">zFB</span><span class="o">::</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Vector</span><span class="p">{</span><span class="kt">TR</span><span class="p">}}</span>
<span class="k">end</span>


<span class="k">struct</span> <span class="kt">RecursiveAllocation</span><span class="p">{</span><span class="kt">TP</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Model</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">TI</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">TVg</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractVector</span><span class="p">,</span>
<span class="w">                        </span><span class="kt">TT</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Tuple</span><span class="p">}</span>
<span class="w">    </span><span class="n">model</span><span class="o">::</span><span class="kt">TP</span>
<span class="w">    </span><span class="n">mc</span><span class="o">::</span><span class="kt">MarkovChain</span>
<span class="w">    </span><span class="n">S</span><span class="o">::</span><span class="kt">TI</span>
<span class="w">    </span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation_Recursive</span>
<span class="w">    </span><span class="n">μgrid</span><span class="o">::</span><span class="kt">TVg</span>
<span class="w">    </span><span class="n">xgrid</span><span class="o">::</span><span class="kt">TVg</span>
<span class="w">    </span><span class="n">Vf</span><span class="o">::</span><span class="kt">Array</span>
<span class="w">    </span><span class="n">policies</span><span class="o">::</span><span class="kt">TT</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">RecursiveAllocation</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">,</span><span class="w"> </span><span class="n">μgrid</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">)</span>
<span class="w">    </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">             </span><span class="c"># number of states</span>
<span class="w">    </span><span class="n">mc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MarkovChain</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">)</span>
<span class="w">    </span><span class="c"># now find the first best allocation</span>
<span class="w">    </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solve_time1_bellman</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">μgrid</span><span class="p">)</span>
<span class="w">    </span><span class="n">T</span><span class="o">.</span><span class="n">time_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w">                  </span><span class="c"># Bellman equation now solves time 0 problem</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">RecursiveAllocation</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">μgrid</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span><span class="p">)</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">solve_time1_bellman</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">{</span><span class="kt">TR</span><span class="p">},</span><span class="w"> </span><span class="n">μgrid</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">TR</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">Real</span><span class="p">}</span>
<span class="w">    </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c"># First get initial fit from lucas stockey solution.</span>
<span class="w">    </span><span class="c"># Need to change things to be ex_ante</span>
<span class="w">    </span><span class="n">PP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">incomplete_allocation</span><span class="p">(</span><span class="n">PP</span><span class="o">::</span><span class="kt">SequentialAllocation</span><span class="p">,</span>
<span class="w">                                </span><span class="n">μ_</span><span class="o">::</span><span class="kt">AbstractFloat</span><span class="p">,</span>
<span class="w">                                </span><span class="n">s_</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time1_value</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span><span class="w"> </span><span class="n">μ_</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">V</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">xprimef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">Vf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">xgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">))</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">s_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">),</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">),</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">))</span>
<span class="w">        </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TR</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">))</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_μ</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">μgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">c</span><span class="p">[</span><span class="n">i_μ</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">[</span><span class="n">i_μ</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i_μ</span><span class="p">],</span><span class="w"> </span><span class="n">V</span><span class="p">[</span><span class="n">i_μ</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">incomplete_allocation</span><span class="p">(</span><span class="n">PP</span><span class="p">,</span><span class="w"> </span><span class="n">μ</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">xprimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">repeat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">xgrid</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">            </span><span class="n">splc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">][</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">])</span>
<span class="w">            </span><span class="n">spln</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">n</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">][</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">])</span>
<span class="w">            </span><span class="n">splx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">xprimes</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">][</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">])</span>
<span class="w">            </span><span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">spln</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splx</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">splV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="k">end</span><span class="o">:-</span><span class="mi">1</span><span class="o">:</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="n">Vf</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splV</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">policies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">nf</span><span class="p">,</span><span class="w"> </span><span class="n">xprimef</span><span class="p">]</span>

<span class="w">    </span><span class="c"># Create xgrid</span>
<span class="w">    </span><span class="n">xbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">maximum</span><span class="p">(</span><span class="n">minimum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)),</span><span class="w"> </span><span class="n">minimum</span><span class="p">(</span><span class="n">maximum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))]</span>
<span class="w">    </span><span class="n">xgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">μgrid</span><span class="p">))</span>

<span class="w">    </span><span class="c"># Now iterate on Bellman equation</span>
<span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BellmanEquation_Recursive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span><span class="p">)</span>
<span class="w">    </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="n">diff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1e-4</span>
<span class="w">        </span><span class="n">PF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">get_policies_time1</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">)</span>
<span class="w">        </span><span class="n">Vfnew</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fit_policy_function</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">PF</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>

<span class="w">        </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">            </span><span class="n">diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">max</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span><span class="w"> </span><span class="n">maximum</span><span class="p">(</span><span class="n">abs</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Vfnew</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span><span class="w"> </span><span class="o">./</span>
<span class="w">                                            </span><span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)))</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">println</span><span class="p">(</span><span class="s">&quot;diff = </span><span class="si">$diff</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="n">Vf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">copy</span><span class="p">(</span><span class="n">Vfnew</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">xgrid</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">fit_policy_function</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation_Recursive</span><span class="p">,</span>
<span class="w">                             </span><span class="n">PF</span><span class="o">::</span><span class="kt">Function</span><span class="p">,</span>
<span class="w">                             </span><span class="n">xgrid</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">TF</span><span class="p">})</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">TF</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractFloat</span><span class="p">}</span>
<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="c"># preallocation</span>
<span class="w">    </span><span class="n">PFvec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="n">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">xgrid</span><span class="p">))</span>
<span class="w">    </span><span class="n">cf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">nf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">xprimef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">TTf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">Vf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Vector</span><span class="p">{</span><span class="kt">Function</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="c"># fit policy fuctions</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">s_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">PFvec</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i_x</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PF</span><span class="p">(</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">splV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">        </span><span class="n">Vf</span><span class="p">[</span><span class="n">s_</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splV</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">            </span><span class="n">splc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sprime</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">spln</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sprime</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">splxprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="n">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sprime</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">splTT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CubicSpline</span><span class="p">(</span><span class="n">PFvec</span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="n">S</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sprime</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">spln</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splxprime</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">            </span><span class="n">TTf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">splTT</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">policies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">nf</span><span class="p">,</span><span class="w"> </span><span class="n">xprimef</span><span class="p">,</span><span class="w"> </span><span class="n">TTf</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">policies</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">Tau</span><span class="p">(</span><span class="n">pab</span><span class="o">::</span><span class="kt">RecursiveAllocation</span><span class="p">,</span>
<span class="w">            </span><span class="n">c</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">,</span>
<span class="w">        </span><span class="n">n</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">model</span>
<span class="w">    </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">),</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">Uc</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">Tau</span><span class="p">(</span><span class="n">pab</span><span class="o">::</span><span class="kt">RecursiveAllocation</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="o">::</span><span class="kt">Real</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="o">::</span><span class="kt">Real</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tau</span><span class="p">(</span><span class="n">pab</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">n</span><span class="p">])</span>


<span class="k">function</span><span class="w"> </span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">pab</span><span class="o">::</span><span class="kt">RecursiveAllocation</span><span class="p">,</span><span class="w"> </span><span class="n">B_</span><span class="o">::</span><span class="kt">Real</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">)</span>
<span class="w">    </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">Vf</span>
<span class="w">    </span><span class="n">xbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">xbar</span>
<span class="w">    </span><span class="n">z0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_policies_time0</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B_</span><span class="p">,</span><span class="w"> </span><span class="n">s0</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">)</span>

<span class="w">    </span><span class="n">c0</span><span class="p">,</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">xprime0</span><span class="p">,</span><span class="w"> </span><span class="n">T0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">c0</span><span class="p">,</span><span class="w"> </span><span class="n">n0</span><span class="p">,</span><span class="w"> </span><span class="n">xprime0</span><span class="p">,</span><span class="w"> </span><span class="n">T0</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">pab</span><span class="o">::</span><span class="kt">RecursiveAllocation</span><span class="p">,</span>
<span class="w">                  </span><span class="n">B_</span><span class="o">::</span><span class="kt">TF</span><span class="p">,</span><span class="w"> </span><span class="n">s_0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                  </span><span class="n">sHist</span><span class="o">::</span><span class="kt">Vector</span><span class="o">=</span><span class="n">simulate</span><span class="p">(</span><span class="n">pab</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="o">=</span><span class="n">s_0</span><span class="p">))</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">TF</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractFloat</span><span class="p">}</span>
<span class="w">    </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">mc</span><span class="p">,</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">Vf</span><span class="p">,</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span>
<span class="w">    </span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">nf</span><span class="p">,</span><span class="w"> </span><span class="n">xprimef</span><span class="p">,</span><span class="w"> </span><span class="n">TTf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pab</span><span class="o">.</span><span class="n">policies</span>

<span class="w">    </span><span class="n">cHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">nHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">Bhist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">xHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">TauHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">THist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>
<span class="w">    </span><span class="n">μHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">)</span>

<span class="w">    </span><span class="c">#time0</span>
<span class="w">    </span><span class="n">cHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">xHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">THist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">time0_allocation</span><span class="p">(</span><span class="n">pab</span><span class="p">,</span><span class="w"> </span><span class="n">B_</span><span class="p">,</span><span class="w"> </span><span class="n">s_0</span><span class="p">)</span>
<span class="w">    </span><span class="n">TauHist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tau</span><span class="p">(</span><span class="n">pab</span><span class="p">,</span><span class="w"> </span><span class="n">cHist</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="n">s_0</span><span class="p">]</span>
<span class="w">    </span><span class="n">Bhist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">B_</span>
<span class="w">    </span><span class="n">μHist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vf</span><span class="p">[</span><span class="n">s_0</span><span class="p">](</span><span class="n">xHist</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="w">    </span><span class="c">#time 1 onward</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">:</span><span class="n">T</span>
<span class="w">        </span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">xHist</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">sHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="n">TT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">sprime</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">            </span><span class="n">c</span><span class="p">[</span><span class="n">sprime</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">[</span><span class="n">sprime</span><span class="p">],</span><span class="w"> </span><span class="n">xprime</span><span class="p">[</span><span class="n">sprime</span><span class="p">],</span><span class="w"> </span><span class="n">TT</span><span class="p">[</span><span class="n">sprime</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">cf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">nf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">](</span><span class="n">x</span><span class="p">),</span>
<span class="w">                </span><span class="n">xprimef</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">TTf</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprime</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>

<span class="w">        </span><span class="n">Tau_val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tau</span><span class="p">(</span><span class="n">pab</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)[</span><span class="n">s</span><span class="p">]</span>
<span class="w">        </span><span class="n">u_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">Eu_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">],</span><span class="w"> </span><span class="n">u_c</span><span class="p">)</span>

<span class="w">        </span><span class="n">μHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Vf</span><span class="p">[</span><span class="n">s</span><span class="p">](</span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>

<span class="w">        </span><span class="n">cHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">nHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">Bhist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">TauHist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">n</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">x</span><span class="o">/</span><span class="n">Eu_c</span><span class="p">,</span><span class="w"> </span><span class="n">Tau_val</span>
<span class="w">        </span><span class="n">xHist</span><span class="p">[</span><span class="n">t</span><span class="p">],</span><span class="w"> </span><span class="n">THist</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">xprime</span><span class="p">[</span><span class="n">s</span><span class="p">],</span><span class="w"> </span><span class="n">TT</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cHist</span><span class="p">,</span><span class="w"> </span><span class="n">nHist</span><span class="p">,</span><span class="w"> </span><span class="n">Bhist</span><span class="p">,</span><span class="w"> </span><span class="n">xHist</span><span class="p">,</span><span class="w"> </span><span class="n">TauHist</span><span class="p">,</span><span class="w"> </span><span class="n">THist</span><span class="p">,</span><span class="w"> </span><span class="n">μHist</span><span class="p">,</span><span class="w"> </span><span class="n">sHist</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">BellmanEquation_Recursive</span><span class="p">(</span><span class="n">model</span><span class="o">::</span><span class="kt">Model</span><span class="p">{</span><span class="kt">TF</span><span class="p">},</span>
<span class="w">                                   </span><span class="n">xgrid</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">{</span><span class="kt">TF</span><span class="p">},</span>
<span class="w">                                   </span><span class="n">policies0</span><span class="o">::</span><span class="kt">Array</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">{</span><span class="kt">TF</span><span class="w"> </span><span class="o">&lt;:</span><span class="w"> </span><span class="kt">AbstractFloat</span><span class="p">}</span>

<span class="w">    </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="c"># number of states</span>
<span class="w">    </span><span class="n">xbar</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">minimum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">),</span><span class="w"> </span><span class="n">maximum</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)]</span>
<span class="w">    </span><span class="n">time_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">    </span><span class="n">z0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">Array</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">(</span><span class="n">xgrid</span><span class="p">),</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="n">cf</span><span class="p">,</span><span class="w"> </span><span class="n">nf</span><span class="p">,</span><span class="w"> </span><span class="n">xprimef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">policies0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">policies0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">policies0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">xgrid</span><span class="p">)</span>
<span class="w">            </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">            </span><span class="n">ns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">            </span><span class="n">xprimes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">Array</span><span class="p">{</span><span class="kt">TF</span><span class="p">}(</span><span class="nb">undef</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">)</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S</span>
<span class="w">                </span><span class="n">cs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">ns</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="w"> </span><span class="n">xprimes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cf</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">nf</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">](</span><span class="n">x</span><span class="p">),</span><span class="w"> </span><span class="n">xprimef</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">](</span><span class="n">x</span><span class="p">)</span>
<span class="w">            </span><span class="k">end</span>
<span class="w">            </span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span><span class="w"> </span><span class="n">ns</span><span class="p">,</span><span class="w"> </span><span class="n">xprimes</span><span class="p">,</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">IFB</span><span class="p">,</span><span class="w"> </span><span class="n">xFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">find_first_best</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BellmanEquation_Recursive</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">,</span><span class="w"> </span><span class="n">time_0</span><span class="p">,</span><span class="w"> </span><span class="n">z0</span><span class="p">,</span><span class="w"> </span><span class="n">cFB</span><span class="p">,</span><span class="w"> </span><span class="n">nFB</span><span class="p">,</span><span class="w"> </span><span class="n">xFB</span><span class="p">,</span><span class="w"> </span><span class="n">zFB</span><span class="p">)</span>
<span class="k">end</span>



<span class="k">function</span><span class="w"> </span><span class="n">get_policies_time1</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation_Recursive</span><span class="p">,</span>
<span class="w">                            </span><span class="n">i_x</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                            </span><span class="n">x</span><span class="o">::</span><span class="kt">Real</span><span class="p">,</span>
<span class="w">                            </span><span class="n">s_</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                            </span><span class="n">Vf</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">Function</span><span class="p">},</span>
<span class="w">                            </span><span class="n">xbar</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">S</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Π</span>
<span class="w">    </span><span class="n">U</span><span class="p">,</span><span class="n">Uc</span><span class="p">,</span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span>

<span class="w">    </span><span class="n">S_possible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]</span><span class="o">.&gt;</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="n">sprimei_possible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findall</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="o">:</span><span class="p">]</span><span class="o">.&gt;</span><span class="mi">0</span><span class="p">)</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">objf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S_possible</span><span class="o">+</span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">])</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">Vprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Vf</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">[</span><span class="n">si</span><span class="p">]](</span><span class="n">xprime</span><span class="p">[</span><span class="n">si</span><span class="p">])</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">si</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">],</span><span class="w"> </span><span class="n">U</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Vprime</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">cons</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="p">,</span><span class="w"> </span><span class="n">TT</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S_possible</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S_possible</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="n">S_possible</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">])</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">u_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">Eu_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">],</span><span class="w"> </span><span class="n">u_c</span><span class="p">)</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">u_c</span><span class="o">/</span><span class="n">Eu_c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u_c</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TT</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xprime</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">cons_no_trans</span><span class="p">(</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">S_possible</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">])</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">]</span>
<span class="w">        </span><span class="n">u_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Uc</span><span class="o">.</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="n">Eu_c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dot</span><span class="p">(</span><span class="n">Π</span><span class="p">[</span><span class="n">s_</span><span class="p">,</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">],</span><span class="w"> </span><span class="n">u_c</span><span class="p">)</span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">u_c</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Eu_c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">u_c</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xprime</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">zeros</span><span class="p">(</span><span class="n">S_possible</span><span class="p">),</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="o">*</span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">S_possible</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">],</span>
<span class="w">                    </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">))</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">),</span>
<span class="w">                    </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
<span class="w">                    </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">))</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="n">sprimei_possible</span><span class="p">],</span>
<span class="w">                    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">2</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">],</span>
<span class="w">                    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">3</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">])</span>
<span class="w">        </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="n">S_possible</span><span class="p">)</span>
<span class="w">        </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">,</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">S_possible</span><span class="p">))</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">zeros</span><span class="p">(</span><span class="n">S_possible</span><span class="p">),</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="o">*</span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="o">-</span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">],</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="o">*</span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">),</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="n">S_possible</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="n">sprimei_possible</span><span class="p">],</span>
<span class="w">                    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">2</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">])</span>
<span class="w">        </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="n">S_possible</span><span class="p">)</span>
<span class="w">        </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons_no_trans</span><span class="p">,</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">S_possible</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">init</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">]</span>
<span class="w">    </span><span class="n">init</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">]</span>

<span class="w">    </span><span class="n">min_objective!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">objf</span><span class="p">)</span>
<span class="w">    </span><span class="n">lower_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">lb</span><span class="p">)</span>
<span class="w">    </span><span class="n">upper_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">ub</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxeval!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">10000000</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxtime!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<span class="w">    </span><span class="n">ftol_rel!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">)</span>
<span class="w">    </span><span class="n">ftol_abs!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mf">1e-8</span><span class="p">)</span>

<span class="w">    </span><span class="p">(</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLopt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:SUCCESS</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:ROUNDOFF_LIMITED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:MAXEVAL_REACHED</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:FTOL_REACHED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:MAXTIME_REACHED</span>
<span class="w">        </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;optimization failed: ret = </span><span class="si">$ret</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="n">sprimei_possible</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="n">S_possible</span><span class="p">]</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">sprimei_possible</span><span class="p">]</span>
<span class="w">    </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">2</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="n">S_possible</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">2</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">3</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">2</span><span class="n">S_possible</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="n">S_possible</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">][</span><span class="mi">3</span><span class="n">S</span><span class="w"> </span><span class="o">.+</span><span class="w"> </span><span class="n">sprimei_possible</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">zeros</span><span class="p">(</span><span class="n">S</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="o">-</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">z0</span><span class="p">[</span><span class="n">i_x</span><span class="p">,</span><span class="w"> </span><span class="n">s_</span><span class="p">])</span>
<span class="k">end</span>


<span class="k">function</span><span class="w"> </span><span class="n">get_policies_time0</span><span class="p">(</span><span class="n">T</span><span class="o">::</span><span class="kt">BellmanEquation_Recursive</span><span class="p">,</span>
<span class="w">                            </span><span class="n">B_</span><span class="o">::</span><span class="kt">Real</span><span class="p">,</span>
<span class="w">                            </span><span class="n">s0</span><span class="o">::</span><span class="kt">Integer</span><span class="p">,</span>
<span class="w">                            </span><span class="n">Vf</span><span class="o">::</span><span class="kt">AbstractArray</span><span class="p">{</span><span class="kt">Function</span><span class="p">},</span>
<span class="w">                            </span><span class="n">xbar</span><span class="o">::</span><span class="kt">AbstractVector</span><span class="p">)</span>
<span class="w">    </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">model</span>
<span class="w">    </span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">G</span>
<span class="w">    </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">Un</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">objf</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Vf</span><span class="p">[</span><span class="n">s0</span><span class="p">](</span><span class="n">xprime</span><span class="p">))</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">cons</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">grad</span><span class="p">)</span>
<span class="w">        </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">xprime</span><span class="p">,</span><span class="w"> </span><span class="n">TT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="w">        </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Θ</span><span class="p">[</span><span class="n">s0</span><span class="p">]</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TT</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">β</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">xprime</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">cons_no_trans</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cons</span><span class="p">(</span><span class="n">vcat</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">grad</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="mf">0.0</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">100</span><span class="p">]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">100.0</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mf">100.0</span><span class="p">]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">4</span><span class="p">])</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.95124922</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1.15926816</span><span class="p">,</span><span class="w">  </span><span class="mf">0.0</span><span class="p">]</span>
<span class="w">        </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span>
<span class="w">        </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="n">lb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">ub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="n">xbar</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">T</span><span class="o">.</span><span class="n">zFB</span><span class="p">[</span><span class="n">s0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span>
<span class="w">        </span><span class="n">init</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.95124922</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mf">1.15926816</span><span class="p">]</span>
<span class="w">        </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opt</span><span class="p">(</span><span class="ss">:LN_COBYLA</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="n">equality_constraint!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">cons_no_trans</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">init</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ub</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&gt;</span><span class="w"> </span><span class="n">ub</span><span class="p">]</span>
<span class="w">    </span><span class="n">init</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lb</span><span class="p">[</span><span class="n">init</span><span class="w"> </span><span class="o">.&lt;</span><span class="w"> </span><span class="n">lb</span><span class="p">]</span>


<span class="w">    </span><span class="n">min_objective!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">objf</span><span class="p">)</span>
<span class="w">    </span><span class="n">lower_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">lb</span><span class="p">)</span>
<span class="w">    </span><span class="n">upper_bounds!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">ub</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxeval!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">100000000</span><span class="p">)</span>
<span class="w">    </span><span class="n">maxtime!</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">)</span>

<span class="w">    </span><span class="p">(</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">,</span><span class="w"> </span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NLopt</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span><span class="w"> </span><span class="n">init</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:SUCCESS</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:ROUNDOFF_LIMITED</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:MAXEVAL_REACHED</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="ss">:FTOL_REACHED</span>
<span class="w">            </span><span class="n">error</span><span class="p">(</span><span class="s">&quot;optimization failed: ret = </span><span class="si">$ret</span><span class="s">&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">model</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">true</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">minf</span><span class="p">,</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">G</span><span class="p">[</span><span class="n">s0</span><span class="p">],</span><span class="w"> </span><span class="n">minx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>get_policies_time0 (generic function with 2 methods)
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="examples">
<h2><a class="toc-backref" href="#id14"><span class="section-number">66.4. </span>Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>We now turn to some examples.</p>
<div class="section" id="anticipated-one-period-war">
<h3><span class="section-number">66.4.1. </span>Anticipated One-Period War<a class="headerlink" href="#anticipated-one-period-war" title="Permalink to this headline">¶</a></h3>
<p>In our lecture on <a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state contingent debt</span></a>
we studied how the government manages uncertainty in a simple setting.</p>
<p>As in that lecture, we assume the one-period utility function</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = {\frac{c^{1-\sigma}}{1-\sigma}} - {\frac{n^{1+\gamma}}{1+\gamma}}
\]</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For convenience in  matching our computer code, we have expressed
utility as a function of <span class="math notranslate nohighlight">\(n\)</span> rather than leisure <span class="math notranslate nohighlight">\(l\)</span></p>
</div>
<p>We consider the same government expenditure process studied in the lecture on
<a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state contingent debt</span></a>.</p>
<p>Government expenditures are known for sure in all periods except one</p>
<ul class="simple">
<li><p>For <span class="math notranslate nohighlight">\(t&lt;3\)</span> or <span class="math notranslate nohighlight">\(t &gt; 3\)</span> we assume that <span class="math notranslate nohighlight">\(g_t = g_l = 0.1\)</span>.</p></li>
<li><p>At <span class="math notranslate nohighlight">\(t = 3\)</span> a war occurs with probability 0.5.</p>
<ul>
<li><p>If there is war, <span class="math notranslate nohighlight">\(g_3 = g_h = 0.2\)</span>.</p></li>
<li><p>If there is no war <span class="math notranslate nohighlight">\(g_3 = g_l = 0.1\)</span>.</p></li>
</ul>
</li>
</ul>
<p>A useful trick is to define  components of the state vector as the following six
<span class="math notranslate nohighlight">\((t,g)\)</span> pairs:</p>
<div class="math notranslate nohighlight">
\[
(0,g_l), (1,g_l), (2,g_l), (3,g_l), (3,g_h), (t\geq 4,g_l)
\]</div>
<p>We think of these 6 states as corresponding to <span class="math notranslate nohighlight">\(s=1,2,3,4,5,6\)</span>.</p>
<p>The transition matrix is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
P = \begin{pmatrix}
  0 &amp; 1 &amp; 0 &amp; 0   &amp; 0   &amp; 0\\
  0 &amp; 0 &amp; 1 &amp; 0   &amp; 0   &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0.5 &amp; 0.5 &amp; 0\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1\\
  0 &amp; 0 &amp; 0 &amp; 0   &amp; 0   &amp; 1
\end{pmatrix}
\end{split}\]</div>
<p>The government expenditure at  each state is</p>
<div class="math notranslate nohighlight">
\[\begin{split}
g = \left(\begin{matrix} 0.1\\0.1\\0.1\\0.1\\0.2\\0.1 \end{matrix}\right)
\end{split}\]</div>
<p>We assume the same utility parameters as in the <a class="reference internal" href="opt_tax_recur.html"><span class="doc">Lucas-Stokey economy</span></a>.</p>
<p>This utility function is implemented in the following constructor</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">crra_utility</span><span class="p">(;</span>
<span class="w">    </span><span class="n">β</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">,</span>
<span class="w">    </span><span class="n">σ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">γ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="p">,</span>
<span class="w">    </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">],</span>
<span class="w">    </span><span class="n">Θ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="kt">Float64</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">    </span><span class="n">transfers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">function</span><span class="w"> </span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">σ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.0</span>
<span class="w">            </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">            </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="o">.^</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">σ</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">σ</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="o">.^</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">γ</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">γ</span><span class="p">)</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="c"># Derivatives of utility function</span>
<span class="w">    </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">c</span><span class="o">.^</span><span class="p">(</span><span class="o">-</span><span class="n">σ</span><span class="p">)</span>
<span class="w">    </span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">σ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">c</span><span class="o">.^</span><span class="p">(</span><span class="o">-</span><span class="n">σ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">n</span><span class="o">.^</span><span class="n">γ</span>
<span class="w">    </span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">γ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n</span><span class="o">.^</span><span class="p">(</span><span class="n">γ</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Model</span><span class="p">(</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">transfers</span><span class="p">,</span>
<span class="w">                </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">Unn</span><span class="p">,</span><span class="w"> </span><span class="n">n_less_than_one</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>crra_utility (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>The following figure plots the Ramsey plan under both complete and incomplete
markets for both possible realizations of the state at time <span class="math notranslate nohighlight">\(t=3\)</span>.</p>
<p>Optimal policies when  the government has  access to state contingent debt are
represented by black lines, while the optimal policies when there is only a risk
free bond are in red.</p>
<p>Paths with circles are histories in which there is peace, while those with
triangle denote war.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">time_example</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">crra_utility</span><span class="p">(</span><span class="n">G</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">],</span>
<span class="w">                            </span><span class="n">Θ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="w"> </span><span class="c"># Θ can in principle be random</span>

<span class="n">time_example</span><span class="o">.</span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">                   </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">                   </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">                   </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">                   </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">                   </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span>

<span class="c"># Initialize μgrid for value function iteration</span>
<span class="n">μgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">range</span><span class="p">(</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span>

<span class="n">time_example</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w">  </span><span class="c"># Government can use transfers</span>
<span class="n">time_sequential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">time_example</span><span class="p">)</span><span class="w"> </span><span class="c"># Solve sequential problem</span>

<span class="n">time_bellman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RecursiveAllocation</span><span class="p">(</span><span class="n">time_example</span><span class="p">,</span><span class="w"> </span><span class="n">μgrid</span><span class="p">)</span>

<span class="n">sHist_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span>
<span class="n">sHist_l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">]</span>

<span class="n">sim_seq_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">time_sequential</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">sHist_h</span><span class="p">)</span>
<span class="n">sim_bel_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">time_bellman</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">sHist_h</span><span class="p">)</span>
<span class="n">sim_seq_l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">time_sequential</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">sHist_l</span><span class="p">)</span>
<span class="n">sim_bel_l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">time_bellman</span><span class="p">,</span><span class="w"> </span><span class="mf">1.</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">sHist_l</span><span class="p">)</span>

<span class="k">using</span><span class="w"> </span><span class="n">Plots</span>

<span class="n">titles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="s">&quot;Consumption&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Labor Supply&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Government Debt&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="s">&quot;Tax Rate&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Government Spending&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Output&quot;</span><span class="p">)</span>
<span class="n">sim_seq_l_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_seq_l</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">sim_seq_l</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_l</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_l</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_seq_l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sim_bel_l_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_bel_l</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">sim_bel_l</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_l</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_l</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_bel_l</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sim_seq_h_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_seq_h</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">sim_seq_h</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_h</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_h</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_seq_h</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sim_bel_h_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_bel_h</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">sim_bel_h</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_h</span><span class="p">],</span>
<span class="w">                      </span><span class="n">time_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_h</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_bel_h</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">920</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="p">),</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w"> </span><span class="n">xaxis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="n">grid</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">titlefont</span><span class="o">=</span><span class="n">Plots</span><span class="o">.</span><span class="n">font</span><span class="p">(</span><span class="s">&quot;sans-serif&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span>
<span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titles</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">:</span><span class="mi">6</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">sim_seq_l_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:circle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:black</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">sim_bel_l_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:circle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:red</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">sim_seq_h_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:utriangle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:black</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="mi">0</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="n">sim_bel_h_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:utriangle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:red</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.05545573932892626
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.05894820861417962
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.05298804217786332
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.05437935197266899
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0018462201896328808
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0017084870909002004
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0006059670356647582
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0005455174588738608
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0004911912886524149
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0004420464883467868
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0003977969812743899
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00035796887638022047
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00032212344256885754
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00028986712036026377
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0002608134900674362
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00023466965302054163
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00021113598212874472
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00018998371865285555
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00017094147083400183
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00015380899495526682
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0001384070099291766
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00012454848077247024
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00011207896725530902
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00010084259614588416
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 9.076645849624518e-5
</pre></div>
</div>
<img alt="../_images/amss_10_25.svg" src="../_images/amss_10_25.svg" /></div>
</div>
<p>How a Ramsey planner responds to  war depends on the structure of the asset market.</p>
<p>If it is able to trade state-contingent debt, then at time <span class="math notranslate nohighlight">\(t=2\)</span></p>
<ul class="simple">
<li><p>the government purchases an Arrow security that pays off when <span class="math notranslate nohighlight">\(g_3 = g_h\)</span></p></li>
<li><p>the government sells an Arrow security that  pays off when <span class="math notranslate nohighlight">\(g_3 = g_l\)</span></p></li>
<li><p>These purchases are designed in such a way that regardless of whether or not there is a war at <span class="math notranslate nohighlight">\(t=3\)</span>, the government will begin  period <span class="math notranslate nohighlight">\(t=4\)</span> with the <em>same</em> government debt.</p></li>
</ul>
<p>This pattern facilities smoothing tax rates across  states.</p>
<p>The government without state contingent debt cannot do this.</p>
<p>Instead, it must enter   time <span class="math notranslate nohighlight">\(t=3\)</span> with the same level of debt falling due whether there is peace or war at <span class="math notranslate nohighlight">\(t=3\)</span>.</p>
<p>It responds to this constraint by smoothing tax rates across time.</p>
<p>To finance a war it raises taxes and issues more debt.</p>
<p>To service the additional debt burden, it raises taxes in all future periods.</p>
<p>The absence of state contingent debt leads to an important difference in the
optimal tax policy.</p>
<p>When the Ramsey planner has access to state contingent debt, the optimal tax
policy is history independent</p>
<ul class="simple">
<li><p>the tax rate is a function  of the current level of government spending only,
given the Lagrange multiplier on the implementability constraint.</p></li>
</ul>
<p>Without state contingent debt, the optimal tax rate is history dependent.</p>
<ul class="simple">
<li><p>A war at time <span class="math notranslate nohighlight">\(t=3\)</span> causes a permanent increase in the tax rate.</p></li>
</ul>
<div class="section" id="perpetual-war-alert">
<h4><span class="section-number">66.4.1.1. </span>Perpetual War Alert<a class="headerlink" href="#perpetual-war-alert" title="Permalink to this headline">¶</a></h4>
<p>History dependence occurs more dramatically in a case in which the government
perpetually faces the prospect  of war.</p>
<p>This case was studied in the final example of the lecture on
<a class="reference internal" href="opt_tax_recur.html"><span class="doc">optimal taxation with state-contingent debt</span></a>.</p>
<p>There, each period the government faces a constant probability, <span class="math notranslate nohighlight">\(0.5\)</span>, of war.</p>
<p>In addition, this example features the following preferences</p>
<div class="math notranslate nohighlight">
\[
u(c,n) = \log(c) + 0.69 \log(1-n)
\]</div>
<p>In accordance, we will re-define our utility function</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="k">function</span><span class="w"> </span><span class="n">log_utility</span><span class="p">(;</span><span class="n">β</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.9</span><span class="p">,</span>
<span class="w">                    </span><span class="n">ψ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.69</span><span class="p">,</span>
<span class="w">                    </span><span class="n">Π</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">                    </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">],</span>
<span class="w">                    </span><span class="n">Θ</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">                    </span><span class="n">transfers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span>
<span class="w">    </span><span class="c"># Derivatives of utility function</span>
<span class="w">    </span><span class="n">U</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ψ</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">Uc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="n">c</span>
<span class="w">    </span><span class="n">Ucc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="o">.^</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">)</span>
<span class="w">    </span><span class="n">Un</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ψ</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="n">Unn</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">ψ</span><span class="w"> </span><span class="o">./</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">.-</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="o">.^</span><span class="mf">2.0</span>
<span class="w">    </span><span class="n">n_less_than_one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Model</span><span class="p">(</span><span class="n">β</span><span class="p">,</span><span class="w"> </span><span class="n">Π</span><span class="p">,</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">Θ</span><span class="p">,</span><span class="w"> </span><span class="n">transfers</span><span class="p">,</span>
<span class="w">                </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">Uc</span><span class="p">,</span><span class="w"> </span><span class="n">Ucc</span><span class="p">,</span><span class="w"> </span><span class="n">Un</span><span class="p">,</span><span class="w"> </span><span class="n">Unn</span><span class="p">,</span><span class="w"> </span><span class="n">n_less_than_one</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>log_utility (generic function with 1 method)
</pre></div>
</div>
</div>
</div>
<p>With these preferences, Ramsey tax rates will vary even in the Lucas-Stokey
model with state-contingent debt.</p>
<p>The figure below plots optimal tax policies for both the economy with
state contingent debt (circles) and the economy with only a risk-free bond
(triangles)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">log_example</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log_utility</span><span class="p">()</span>

<span class="n">log_example</span><span class="o">.</span><span class="n">transfers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w">                             </span><span class="c"># Government can use transfers</span>
<span class="n">log_sequential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SequentialAllocation</span><span class="p">(</span><span class="n">log_example</span><span class="p">)</span><span class="w">       </span><span class="c"># Solve sequential problem</span>
<span class="n">log_bellman</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RecursiveAllocation</span><span class="p">(</span><span class="n">log_example</span><span class="p">,</span><span class="w"> </span><span class="n">μgrid</span><span class="p">)</span><span class="w">    </span><span class="c"># Solve recursive problem</span>

<span class="n">T</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span>
<span class="n">sHist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span>

<span class="c">#simulate</span>
<span class="n">sim_seq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">log_sequential</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">sHist</span><span class="p">)</span>
<span class="n">sim_bel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">log_bellman</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">sHist</span><span class="p">)</span>

<span class="n">sim_seq_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_seq</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span>
<span class="w">            </span><span class="n">sim_seq</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_seq</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sim_bel_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_bel</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span>
<span class="w">            </span><span class="n">sim_bel</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_bel</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c">#plot policies</span>
<span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">920</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="p">),</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grid</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span>
<span class="w">         </span><span class="n">xaxis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="n">T</span><span class="p">),</span><span class="w"> </span><span class="n">grid</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="n">titlefont</span><span class="o">=</span><span class="n">Plots</span><span class="o">.</span><span class="n">font</span><span class="p">(</span><span class="s">&quot;sans-serif&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span>
<span class="n">labels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fill</span><span class="p">((</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">),</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Complete Market&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Incomplete Market&quot;</span><span class="p">)</span>
<span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titles</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vcat</span><span class="p">(</span><span class="n">collect</span><span class="p">(</span><span class="mi">1</span><span class="o">:</span><span class="mi">4</span><span class="p">),</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">sim_seq_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:circle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:black</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">sim_bel_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:utriangle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:blue</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="w">          </span><span class="n">legend</span><span class="o">=</span><span class="ss">:bottomright</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">sim_seq_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">marker</span><span class="o">=</span><span class="ss">:circle</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:blue</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0007972383286751266
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0006422479721426341
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0005516714642152489
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.000485538815688431
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0004226122736966621
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0003754551259341305
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00032934357539644437
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0002932414314594749
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00025845347938131005
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0002302657709037761
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0002035780400847809
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00018139957013859378
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0001607151961719876
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00014318438885313562
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.0001270615310969653
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00011255971952117789
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 0.00010088438997328722
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>diff = 8.957635941783829e-5
</pre></div>
</div>
<img alt="../_images/amss_14_18.svg" src="../_images/amss_14_18.svg" /></div>
</div>
<p>When the government experiences a prolonged period of peace, it is able to reduce
government debt and set permanently lower tax rates.</p>
<p>However, the government  finances a long war by borrowing and raising taxes.</p>
<p>This results in a drift away from  policies with state contingent debt that
depends on the history of shocks.</p>
<p>This is even more evident in the following figure that plots the evolution of
the two policies over 200 periods</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-julia notranslate"><div class="highlight"><pre><span></span><span class="n">T_long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span>
<span class="n">sim_seq_long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">log_sequential</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">T_long</span><span class="p">)</span>
<span class="n">sHist_long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sim_seq_long</span><span class="p">[</span><span class="k">end</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="n">sim_bel_long</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simulate</span><span class="p">(</span><span class="n">log_bellman</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">T_long</span><span class="p">,</span><span class="w"> </span><span class="n">sHist_long</span><span class="p">)</span>
<span class="n">sim_seq_long_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_seq_long</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">4</span><span class="p">]</span><span class="o">...</span><span class="p">,</span>
<span class="w">             </span><span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_long</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_long</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_seq_long</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">sim_bel_long_plot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hcat</span><span class="p">(</span><span class="n">sim_bel_long</span><span class="p">[</span><span class="mi">1</span><span class="o">:</span><span class="mi">3</span><span class="p">]</span><span class="o">...</span><span class="p">,</span><span class="w"> </span><span class="n">sim_bel_long</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
<span class="w">             </span><span class="n">log_example</span><span class="o">.</span><span class="n">G</span><span class="p">[</span><span class="n">sHist_long</span><span class="p">],</span><span class="w"> </span><span class="n">log_example</span><span class="o">.</span><span class="n">Θ</span><span class="p">[</span><span class="n">sHist_long</span><span class="p">]</span><span class="w"> </span><span class="o">.*</span><span class="w"> </span><span class="n">sim_bel_long</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">920</span><span class="p">,</span><span class="w"> </span><span class="mi">750</span><span class="p">),</span><span class="w"> </span><span class="n">layout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">xaxis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span><span class="n">T_long</span><span class="p">),</span><span class="w"> </span><span class="n">grid</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
<span class="w">         </span><span class="n">titlefont</span><span class="o">=</span><span class="n">Plots</span><span class="o">.</span><span class="n">font</span><span class="p">(</span><span class="s">&quot;sans-serif&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span>
<span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titles</span><span class="p">)</span>
<span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="o">:</span><span class="mi">6</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">sim_seq_long_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:black</span><span class="p">,</span><span class="w"> </span><span class="n">linestyle</span><span class="o">=</span><span class="ss">:solid</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="w">    </span><span class="n">plot!</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">sim_bel_long_plot</span><span class="p">[</span><span class="o">:</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="ss">:blue</span><span class="p">,</span><span class="w"> </span><span class="n">linestyle</span><span class="o">=</span><span class="ss">:dot</span><span class="p">,</span><span class="w"> </span><span class="n">lab</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
<span class="w">          </span><span class="n">legend</span><span class="o">=</span><span class="ss">:bottomright</span><span class="p">)</span>
<span class="k">end</span>
<span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/amss_17_0.svg" src="../_images/amss_17_0.svg" /></div>
</div>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="fn-a"><span class="brackets"><a class="fn-backref" href="#id6">1</a></span></dt>
<dd><p>In an allocation that solves the Ramsey problem and that levies distorting
taxes on labor, why would the government ever want to hand revenues back
to the private sector? It would not in an economy with state-contingent debt, since
any such allocation could be improved by lowering distortionary taxes
rather than handing out lump-sum transfers. But without state-contingent
debt  there can be circumstances when a government would like to make
lump-sum transfers to the private sector.</p>
</dd>
<dt class="label" id="fn-b"><span class="brackets"><a class="fn-backref" href="#id7">2</a></span></dt>
<dd><p>From the first-order conditions for the Ramsey
problem, there exists another realization <span class="math notranslate nohighlight">\(\tilde s^t\)</span> with
the same history up until the previous period, i.e., <span class="math notranslate nohighlight">\(\tilde s^{t-1}=
s^{t-1}\)</span>, but where the multiplier on constraint <a class="reference internal" href="#equation-amss-46">(66.11)</a> takes  a positive value, so
<span class="math notranslate nohighlight">\(\gamma_t(\tilde s^t)&gt;0\)</span>.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "julia-1.8"
        },
        kernelOptions: {
            kernelName: "julia-1.8",
            path: "./dynamic_programming_squared"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'julia-1.8'</script>

                    </div>
                    
                </main> <!-- .page__content -->
                


                <footer class="qe-page__footer">

                    <p><a href="https://creativecommons.org/licenses/by-sa/4.0/"><img src="https://licensebuttons.net/l/by-sa/4.0/80x15.png"></a></p>

                    <p>Creative Commons License &ndash; This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International.</p>

                </footer> <!-- .page__footer -->

            </div> <!-- .page -->

            

            
            <div class="qe-sidebar bd-sidebar inactive" id="site-navigation">

                <div class="qe-sidebar__header">


                    Contents

                </div>

                <nav class="qe-sidebar__nav" id="qe-sidebar-nav" aria-label="Main navigation">
                    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting Started with Julia
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/getting_started.html">
   1. Setting up Your Julia Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/julia_by_example.html">
   2. Introductory Examples
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/julia_essentials.html">
   3. Julia Essentials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/fundamental_types.html">
   4. Arrays, Tuples, Ranges, and Other Fundamental Types
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../getting_started_julia/introduction_to_types.html">
   5. Introduction to Types and Generic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Package Ecosystem
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/generic_programming.html">
   6. Generic Programming
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/general_packages.html">
   7. General Purpose Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/data_statistical_packages.html">
   8. Data and Statistics Packages
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../more_julia/optimization_solver_packages.html">
   9. Solvers, Optimizers, and Automatic Differentiation
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Software Engineering
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../software_engineering/tools_editors.html">
   10. Visual Studio Code and Other Tools
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../software_engineering/version_control.html">
   11. GitHub, Version Control and Collaboration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../software_engineering/testing.html">
   12. Packages, Testing, and Continuous Integration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../software_engineering/need_for_speed.html">
   13. The Need for Speed
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Tools and Techniques
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/geom_series.html">
   14. Geometric Series for Elementary Economics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/linear_algebra.html">
   15. Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/orth_proj.html">
   16. Orthogonal Projections and Their Applications
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/lln_clt.html">
   17. LLN and CLT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/stationary_densities.html">
   18. Continuous State Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/numerical_linear_algebra.html">
   19. Numerical Linear Algebra and Factorizations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tools_and_techniques/iterative_methods_sparsity.html">
   20. Krylov Methods and Matrix Conditioning
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction to Dynamics
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/scalar_dynam.html">
   21. Dynamics in One Dimension
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/ar1_processes.html">
   22. AR1 Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/finite_markov.html">
   23. Finite Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/linear_models.html">
   24. Linear State Space Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/wealth_dynamics.html">
   25. Wealth Distribution Dynamics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/kalman.html">
   26. A First Look at the Kalman Filter
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../introduction_dynamics/short_path.html">
   27. Shortest Paths
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/mccall_model.html">
   28. Job Search I: The McCall Search Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/mccall_model_with_separation.html">
   29. Job Search II: Search and Separation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/wald_friedman.html">
   30. A Problem that Stumped Milton Friedman
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/odu.html">
   31. Job Search III: Search with Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/career.html">
   32. Job Search IV: Modeling Career Choice
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/jv.html">
   33. Job Search V: On-the-Job Search
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/optgrowth.html">
   34. Optimal Growth I: The Stochastic Optimal Growth Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/coleman_policy_iter.html">
   35. Optimal Growth II: Time Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/egm_policy_iter.html">
   36. Optimal Growth III: The Endogenous Grid Method
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/lqcontrol.html">
   37. LQ Dynamic Programming Problems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/perm_income.html">
   38. Optimal Savings I: The Permanent Income Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/perm_income_cons.html">
   39. Optimal Savings II: LQ Techniques
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/smoothing.html">
   40. Consumption and Tax Smoothing with Complete and Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/ifp.html">
   41. Optimal Savings III: Occasionally Binding Constraints
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/robustness.html">
   42. Robustness
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dynamic_programming/discrete_dp.html">
   43. Discrete State Dynamic Programming
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Modeling in Continuous Time
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../continuous_time/seir_model.html">
   44. Modeling COVID 19 with Differential Equations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../continuous_time/covid_sde.html">
   45. Modeling Shocks in COVID 19 with Stochastic Differential Equations
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Multiple Agent Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/schelling.html">
   46. Schelling’s Segregation Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/lake_model.html">
   47. A Lake Model of Employment and Unemployment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/rational_expectations.html">
   48. Rational Expectations Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/markov_perf.html">
   49. Markov Perfect Equilibrium
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/markov_asset.html">
   50. Asset Pricing I: Finite State Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/lucas_model.html">
   51. Asset Pricing II: The Lucas Asset Pricing Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/harrison_kreps.html">
   52. Asset Pricing III:  Incomplete Markets
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/uncertainty_traps.html">
   53. Uncertainty Traps
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/aiyagari.html">
   54. The Aiyagari Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/arellano.html">
   55. Default Risk and Income Fluctuations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../multi_agent_models/matsuyama.html">
   56. Globalization and Cycles
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Time Series Models
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/arma.html">
   57. Covariance Stationary Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/estspec.html">
   58. Estimation of Spectra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/additive_functionals.html">
   59. Additive Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/multiplicative_functionals.html">
   60. Multiplicative Functionals
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/lu_tricks.html">
   61. Classical Control with Linear Algebra
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../time_series_models/classical_filtering.html">
   62. Classical Filtering With Linear Algebra
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Dynamic Programming Squared
 </span>
</p>
<ul class="current nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="dyn_stack.html">
   63. Dynamic Stackelberg Problems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="lqramsey.html">
   64. Optimal Taxation in an LQ Economy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="opt_tax_recur.html">
   65. Optimal Taxation with State-Contingent Debt
  </a>
 </li>
 <li class="toctree-l1 current active active">
  <a class="current reference internal" href="#">
   66. Optimal Taxation without State-Contingent Debt
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Other
 </span>
</p>
<ul class="nav bd-sidenav nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../about_lectures.html">
   67. About these Lectures
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../troubleshooting.html">
   68. Troubleshooting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../zreferences.html">
   69. References
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../status.html">
   70. Execution Statistics
  </a>
 </li>
</ul>

                </nav>

                <div class="qe-sidebar__footer">

                </div>

            </div> <!-- .sidebar -->
            
        </div> <!-- .main -->

        <div class="qe-toolbar">

            <div class="qe-toolbar__inner">

                <ul class="qe-toolbar__main">
                    <li data-tippy-content="Table of Contents" class="btn__sidebar"><i data-feather="menu"></i></li>
                    <li data-tippy-content="Home"><a href="../intro.html"><i data-feather="home"></i></a></li>
                    <li class="btn__qelogo"><a href="https://quantecon.org" title=""><span class="show-for-sr">QuantEcon</span></a></li>
                    <!-- <li class="btn__search">
                        <form action="../search.html" method="get">
                            <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off">
                            <i data-feather="search"></i>
                        </form>
                    </li> -->
                </ul>

                <ul class="qe-toolbar__links">
                    <li data-tippy-content="Fullscreen" class="btn__fullscreen"><i data-feather="maximize"></i></li>
                    <li data-tippy-content="Increase font size" class="btn__plus"><i data-feather="plus-circle"></i></li>
                    <li data-tippy-content="Decrease font size" class="btn__minus"><i data-feather="minus-circle"></i></li>
                    <li data-tippy-content="Change contrast" class="btn__contrast"><i data-feather="sunset"></i></li>
                    <li data-tippy-content="Download Notebook"><a href="/_notebooks/dynamic_programming_squared/amss.ipynb" download><i data-feather="download-cloud"></i></a></li>
                    <li class="settings-button" id="settingsButton"><div data-tippy-content="Launch Notebook"><i data-feather="play-circle"></i></div></li>
                        <li class="download-pdf" id="downloadButton"><i data-feather="file"></i></li>
                    <li data-tippy-content="View Source"><a target="_blank" href="https://github.com/QuantEcon/lecture-julia.myst/tree/main/lectures/dynamic_programming_squared/amss.md" download><i data-feather="github"></i></a></li>
                </ul>

            </div>

        </div> <!-- .toolbar -->
        <div id="downloadPDFModal" style="display: none;">
            <ul class="pdf-options" style="display: block;">
                <li class="download-pdf-book" onClick="window.print()">
                    <p>Lecture (PDF)</p>
                </li>
                <li class="download-pdf-file">
                    <a href="/_pdf/quantecon-julia.pdf" download><p>Book (PDF)</p></a>
                </li>
            </ul>
        </div>
        <div id="settingsModal" style="display: none;">
            <p class="modal-title"> Notebook Launcher </p>
            <div class="modal-desc">
            <p>
                Choose public or private cloud service for "Launch" button.
            </p>
            </div>
            <p class="modal-subtitle">Select a server</p>
            <ul class="modal-servers">
            <li class="active launcher-public">
                <span class="label">Public</span>
                <select id="launcher-public-input">
                
                    <option value="https://mybinder.org/v2/gh/QuantEcon/lecture-julia.notebooks/main?urlpath=tree/dynamic_programming_squared/amss.ipynb">BinderHub</option>
                
                </select>
                <i class="fas fa-check-circle"></i>
            </li>
            <li class="launcher-private">
                <span class="label">Private</span>
                <input type="text" id="launcher-private-input" data-repourl="https://github.com/QuantEcon/lecture-julia.notebooks" data-urlpath="tree/lecture-julia.notebooks/dynamic_programming_squared/amss.ipynb" data-branch=main>
                <i class="fas fa-check-circle"></i>
            </li>
            </ul>
            <p class="launch"><a href="https://mybinder.org/v2/gh/QuantEcon/lecture-julia.notebooks/main?urlpath=tree/dynamic_programming_squared/amss.ipynb" id="advancedLaunchButton" target="_blank">Launch Notebook</a></p>
            <script>
                // QuantEcon Notebook Launcher
                const launcherTypeElements = document.querySelectorAll('#settingsModal .modal-servers li');
                // Highlight the server type if previous selection exists
                if (typeof localStorage.launcherType !== 'undefined') {
                  for (var i = 0; i < launcherTypeElements.length; i++) {
                    launcherTypeElements[i].classList.remove('active');
                    if ( launcherTypeElements[i].classList.contains(localStorage.launcherType) ) {
                      launcherTypeElements[i].classList.add('active');
                    }
                  }
                }
                // Highlight server type on click and set local storage value
                for (var i = 0; i < launcherTypeElements.length; i++) {
                  launcherTypeElements[i].addEventListener('click', function() {
                    for (var j = 0; j < launcherTypeElements.length; j++) {
                      launcherTypeElements[j].classList.remove('active');
                    }
                    this.classList.add('active');
                    if ( this.classList.contains('launcher-private') ) {
                      localStorage.launcherType = 'launcher-private';
                    } else if ( this.classList.contains('launcher-public') ) {
                      localStorage.launcherType = 'launcher-public';
                    }
                    setLaunchServer();
                  })
                }
                const launcherPublic = document.getElementById('launcher-public-input');
                const launcherPrivate = document.getElementById('launcher-private-input');
                const pageName = "dynamic_programming_squared/amss";
                const repoURL = "https://github.com/QuantEcon/lecture-julia.notebooks";
                const urlPath = "tree/lecture-julia.notebooks/dynamic_programming_squared/amss.ipynb";
                const branch = "main"
                const launchNotebookLink = document.getElementById('advancedLaunchButton');

                // Highlight public server option if previous selection exists
                if (typeof localStorage.launcherPublic !== 'undefined') {
                  launcherPublic.value = localStorage.launcherPublic;
                }
                // Update local storage upon public server selection
                launcherPublic.addEventListener('change', (event) => {
                  setLaunchServer();
                });
                // Populate private server input if previous entry exists
                if (typeof localStorage.launcherPrivate !== 'undefined') {
                  launcherPrivate.value = localStorage.launcherPrivate;
                }
                // Update local storage when a private server is entered
                launcherPrivate.addEventListener('input', (event) => {
                  setLaunchServer();
                });

                // Function to update the "Launch Notebook" link href
                function setLaunchServer() {
                  launchNotebookLink.removeAttribute("style")
                  if ( localStorage.launcherType == 'launcher-private' ) {
                    let repoPrefix = "/jupyter/hub/user-redirect/git-pull?repo=" + repoURL + "&branch=" + branch + "&urlpath=" + urlPath;
                    launcherPrivateValue = launcherPrivate.value
                    if (!launcherPrivateValue) {
                        launchNotebookLink.removeAttribute("href")
                        launchNotebookLink.style.background = "grey"
                        return
                    }
                    localStorage.launcherPrivate = launcherPrivateValue;
                    privateServer = localStorage.launcherPrivate.replace(/\/$/, "")
                    if (!privateServer.includes("http")) {
                        privateServer = "http://" + privateServer
                    }
                    launchNotebookLinkURL = privateServer + repoPrefix;
                  } else if ( localStorage.launcherType == 'launcher-public' ) {
                    launcherPublicValue = launcherPublic.options[launcherPublic.selectedIndex].value;
                    localStorage.launcherPublic = launcherPublicValue;
                    launchNotebookLinkURL = localStorage.launcherPublic;
                  }
                  if (launchNotebookLinkURL) launchNotebookLink.href = launchNotebookLinkURL;
                }
                // Check if user has previously selected a server
                if ( (typeof localStorage.launcherPrivate !== 'undefined') || (typeof localStorage.launcherPublic !== 'undefined') ) {
                  setLaunchServer();
                }
                </script>

        </div>

    </div> <!-- .wrapper-->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-54984338-8', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </body>
</html>